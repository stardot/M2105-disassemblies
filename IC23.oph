.include "MOS.oph"

; 0767: cursor x position
; 0768: cursor y position

; $3030:               35
; $3060: 60
; $3130:       32
; $3300: 00
; $3350:             54
; $3360:                   66 67
; $3400:                                           0e
; $3410:       12 13 14         18 19
; $3420: 20 21                     29


; Note: Uses these addresses in page &FD:
;
; $fd00: 00 01 02 03 04 05    07 08 09 0a 0b 0c 0d 0e 0f
; $fd10: 10 11 12 13 14 15 16 17 18 19 1a 1b 1c    1e
; $fd50:          53                         5c 5d
; $fde0:                               ea eb ec

.org $8000

; ram_osword_81 in IC22
.alias ram_osword_81 $3354

ic23_start:
_8000:
    nop
    nop

; This routine is called from RAM. Its entry point is the address defined by
; the high byte at bf01 and the low byte at bf80, plus one. The offset is due
; to the use of an RTS instruction to enter the routine.

; Note: Groups of routines that look unreachable from RAM entry points are
; marked with ?< at the beginning and >? at the end.

; 8002
entry_from_ram:     ; RAM entry point 0 ($93 global)
    ldx #$02
    stx $2d
    lda #$ef
    ldy #$8a
    ldx #$1d        ; $83d1 in IC22
    jsr $3300
    ldx #$03
    stx $2d
    lda #$28
    ldy #$8a
    ldx #$28        ; $8455 in IC22
    jsr $3300
    ldx #$04
    stx $2d
    lda #$44
    ldy #$8b
    ldx #$28        ; $8455 in IC22
    jsr $3300
    ldx #$05
    stx $2d
    lda #$a1
    ldy #$8b
    ldx #$28        ; $8455 in IC22
    jsr $3300
    jsr _8a88
    lda #$80
    sta $3418
    jsr _807d
    lda #$ff
    sta $3929
    lda #$00
    sta $3b39
    lda #$00
    sta $3b3a
    lda #$ff
    sta $362f
    lda #$2f
    sta $14
    lda #$36
    sta $15
    jsr _98b7
    lda #$00
    sta $362f
    ldx $3b3a
    beq _8072
    lda $3419
    ora #$01
    sta $3419
_8072:
    txa
    jsr _81f5
    jmp _80f0

_8079:              ; Unused?
    ldx $3412
    rts

_807d:                  ; RAM entry point 7
    lda #$19            ; Read modem status
    jsr ram_osword_81
    php
    sei
    ldx #$07
    stx $2d
    ldx #$1b
    jsr $3300
    lda #$1b            ; Enable modem interrupts
    ldx #$10
    jsr ram_osword_81
    plp
    rts

_8096:
    jsr _80a8
    bcs _809e
    jsr _80e1
_809e:
    rts

_809f:
    jsr _80a8
    bcc _80a7
    jsr _80f0
_80a7:
    rts

_80a8:
    lda $362b
    eor #$ff
    cmp #$00
    beq _80bd
    lda $362b
    eor #$00
    cmp #$01
    bcc _80bd
    brk
_80bb:
.byte $82,$00
_80bd:
    rts

_80be:              ; RAM entry point 2
    ldx #$08
    lda #$15        ; Flush speech buffer (X=8)
    jsr OSBYTE
    lda $362b
    cmp #$00
    bne _80cf
    jmp _80e1
_80cf:
    jsr _80f0
    ldx #$0d
    jsr _8106
    ldx #$0c
    jsr _8106
    ldx #$06
    jmp _8106

_80e1:              ; RAM entry point 3
    lda #$ff
    sta $362b
    lda #$00
    sta $3b03
    ldx #$76
    jmp _80ff

_80f0:
    lda #$00
    sta $362b
    lda #$1e
    sta $3b03
    ldx #$77
    jmp _80ff

_80ff:
    stx $2d
    ldx #$01        ; a4c9 in ROM 1 (IC22)
    jmp $3300

_8106:
    stx $2d
    lda #$40
    ldx #$27        ; 8533 in ROM 1 (IC22)
    jmp $3300

_810f:
    lda #$04
    bne _8119
_8113:
    lda #$05
    bne _8119
_8117:
    lda #$03
_8119:
    sta $2d
    ldx #$02        ; a5c1 in ROM 1 (IC22)
    jmp $3300

_8120:
    ldx #$12
    stx $2d
    ldx #$04        ; a48f in ROM 1 (IC22)
    jmp $3300

_8129:          ; ?<
    ldx #$00
    bne _8134   ; >?

_812d:
    txa
    pha
    jsr _8117
    pla
    tax
_8134:
    stx $2d
    ldx #$01        ; $a4c9 in IC22
    jmp $3300

_813b:          ; ?<
    ldx #$01
    jsr _8134
    jmp _8113
_8143:
    ldx #$03
    jmp _8134
_8148:
    ldx #$05
    jmp _8134
_814d:
    ldx #$06
    jmp _812d
    ldx #$07
    jmp _812d
_8157:
    ldx #$08
    jmp _812d
_815c:
    ldx #$09
    jmp _812d
_8161:
    ldx #$0a
    jmp _8134
_8166:
    ldx #$0b
    jmp _812d
_816b:
    ldx #$0c
    jmp _812d
_8170:
    jsr _8117
    ldx #$0d
    jmp _812d
_8178:
    ldx #$0e
    jmp _812d
_817d:
    ldx #$10
    jmp _812d
_8182:
    ldx #$11
    jmp _8134
_8187:
    ldx #$12
    jmp _8134
_818c:
    ldx #$14
    jmp _8134
    ldx #$15
    jmp _812d
_8196:
    ldx #$16
    jmp _812d
    ldx #$17
    jmp _812d
_81a0:
    ldx #$18
    jmp _8134
_81a5:
    ldx #$19
    jmp _812d
_81aa:
    ldx #$1a
    jmp _812d
    ldx #$1b
    jmp _812d
_81b4:
    ldx #$1c
    jmp _812d
_81b9:
    ldx #$1d
    jmp _812d
_81be:
    ldx #$1f
    jmp _812d
_81c3:
    ldx #$20
    jmp _812d
_81c8:
    ldx #$21
    jmp _812d   ; >?

_81cd:
    ldx #$22
    jmp _812d

_81d2:          ; ?<
    ldx #$1e
    jmp _812d
    ldx #$0f
    jmp _812d
    lda $3419
    ora #$01
    sta $3419
    inc $fdea
    jmp _81f8
_81ea:
    dec $fdea
    bit $fdea
    bpl _81f8
    brk
_81f3:
.byte $85,$00   ; >?

_81f5:
    sta $fdea
_81f8:
    lda $fdea
    ldy #$00
    ldx #$1b
    stx $2d
    ldx #$ff
    stx $3606
    ldx #$0c
    jmp $3300

_820b:          ; ?<
    jsr _8222
    lda $fdeb
    ldy $fdec
    ldx #$1a
    stx $2d
    ldx #$ff
    stx $3606
    ldx #$0c
    jmp $3300   ; >?

_8222:       ; RAM entry point 8
    ldy $fdec
    ldx $fdeb
    inx
    bne +
    iny
*
    cpx #$e8
    tya
    sbc #$03
    bcc _8237
    ldx #$01
    ldy #$00
_8237:
    sty $fdec
    stx $fdeb
    rts

_823e:
    pha
    stx $3749
    ldy $374a
    sty $3b09
    ldy #$ff
    sty $374a
    lda $3749
    jsr _9848
    lda #$ff
    tay
    jsr _9856
    lda $3749
    cmp #$10
    beq _826d
    jsr _80a8
    bcs _826d
    lda #$c0
    sta $374a
    jmp _8288
_826d:
    lda $3749
    cmp #$90
    bne _8283
    pla
    lda #$0d
    sta $3412
    lda #$6a
    ldy #$37
    ldx #$a8
    jmp $3300
_8283:
    ldx #$bf
    jsr $3300
_8288:
    ldy #$fe
    lda $374a
    jsr _9856
    pla
    eor $374a
    cmp #$01
    lda $374a
    rts

_829a:
    lda #$30
    ldx #$10
    jmp _823e

_82a1:              ; ?<
    ldx #$15
_82a3:
    lda $fd07,x     ; Read from $fd07-$fd1c
    sta $3754,x
    dex
    bpl _82a3
    rts

_82ad:
    ldx #$00
    ldy #$00
_82b1:
    tya
    bmi _82ba
    lda ($14),y
    cmp #$3b
    bne _82be
_82ba:
    ldy #$80
    lda #$20
_82be:
    sta $376a,x
    inx
    iny
    cpx #$16
    bcc _82b1
    rts             ; >?

_82c8:              ; ?<
    lda $fd00
    sta $3799
    lda _82ff
    and #$0f
    sta $3798
    lda _8301
    and #$0f
    asl
    asl
    asl
    asl
    ora $3798
    sta $3798
    lda #$03
    sta $3797
    lda #$0f
    sta $3796
    lda _8302
    and #$0f
    asl
    asl
    asl
    asl
    ora $3796
    sta $3796
    rts

_82ff:
.byte $33,$2e
_8301: .byte $35
_8302: .byte $30    ; >?

_8303:              ; ?<
    lda #$00
    sta $379d
    sta $379c
    sta $379b
    sta $379a
    rts

_8312:
    ldx $39cb
    stx $374c
    beq _8323
_831a:
    lda $39ca,x
    sta $0b01,x
    dex
    bne _831a
_8323:
    rts

_8324:
    ldx $0b02
    stx $39cb
    beq _8335
_832c:
    lda $0b01,x
    sta $39ca,x
    dex
    bne _832c
_8335:
    rts

_8336:
    lda #$00
    sta $3ae7
    sta $3ae8
    sta $3752
    sta $374f
    jsr _82c8
    jsr _8303
    jsr _82a1
    jsr _82ad
    jsr _880e
    lda $3959
    sta $3753
    lda #$40
    ldx #$20
    jmp _823e

_8360:
    jsr _82a1
    lda #$70
    ldx #$30
    jmp _823e

_836a:
    ldx #$00
    lda $379e
    beq _8379
    ldx #$9f
    jsr $3300
    jmp _8388
_8379:
    lda $395b,x
    sta $0b02,x
    inx
    cpx $395b
    bcc _8379
    stx $374c
_8388:
    lda #$00
    sta $3ae7
    sta $3ae8
    jmp _83e7

_8393:
    lda #$00
    sta $0b02
    sta $0b04
    lda #$01
    sta $0b03
    lda #$03
    sta $374c
    lda #$00
    sta $3ae7
    sta $3ae8
    jmp _83e7

_83b0:
    lda $379e
    beq _83bb
    lda $374d
    jmp _83be
_83bb:
    lda $39cb
_83be:
    tay
    cpy #$fd
    bcc _83c8
    beq _83c8
    brk
_83c6:
.byte $80,$00
_83c8:
    ldx $3ae8
    cpx #$ff
    beq _83dc
    clc
    adc $3ae7
    bcs _83dc
    tax
    cpx #$fd
    bcc _83fe
    beq _83fe
_83dc:
    lda $3ae7
    sta $374c
    bne _83e7
    brk
_83e5:
.byte $81,$00
_83e7:
    lda #$60
    ldx #$40
    jsr _823e
    ldx $3ae7
    beq _83fd
    lda #$00
    sta $3ae7
    sta $3ae8
    bcc _83b0
_83fd:
    rts
_83fe:
    stx $3ae7
    inc $3ae8
_8404:
    lda $39ca,y
    sta $0b01,x
    dex
    dey
    bne _8404
    lda #$60
    clc
    rts

_8412:
    stx $374f
    ldx #$ff
    stx $3750
    lda #$d0
    ldx #$60
    jmp _823e

_8421:
    lda #$80
    ldx #$70
    jmp _823e

_8428:
    lda #$a0
    ldx #$80
    jmp _823e

_842f:
    jsr _82ad

_8432:
    lda #$e0
    ldx #$90
    jmp _823e

_8439:
    lda #$00
    sta $3ae7
    sta $3ae8
    sta $3752
    sta $374f
    jsr _8303
    lda #$50
    ldx #$a0
    jmp _823e

_8451:
    lda #$20
    ldx #$b0
    jmp _823e

_8458:
    lda #$fa
    ldx #$c0
    jmp _823e

_845f:
    lda #$fe
    ldx #$c0
    jmp _823e

_8466:
    lda #$fb
    ldx #$e0
    jmp _823e

_846d:
    lda #$fc
    ldx #$d0
    jmp _823e

_8474:
    ldy #$00
    lda $39cb,y
    sta $374d
    cmp #$01
    beq _8498
    tax
    dex
_8482:
    lda $39cc,y
    cmp #$23
    bne _848b
    lda #$ca
_848b:
    cmp #$60
    bne _8491
    lda #$23
_8491:
    sta $39cb,y
    iny
    dex
    bne _8482
_8498:
    inc $374d
    lda #$20
    sta $39cb,y
    iny
    lda #$0d
    sta $39cb,y
    rts

_84a7:
    jsr _88f9
    lda #$00
    sta $37bc
    sta $37bd
    ldx #$9f
    jsr $3300
_84b7:
    jsr _890d
    bcs _84dd
    lda #$00
    jsr _8ac8
    jsr _8474
    lda $374d
    clc
    adc $37bd
    sta $37bd
    bcc _84b7
    lda $37bc
    adc #$00
    sta $37bc
    bcc _84b7
    brk
_84db:
.byte $c1,$00
_84dd:
    rts

_84de:
    ldx #$15
_84e0:
    lda #$20
    sta $3780,x
    dex
    bpl _84e0
    rts

_84e9:
    lda #$00
    tay
_84ec:
    sta $37c5,y
    iny
    cpy #$0c
    bcc _84ec
    sta $342d
    sta $342e
    sta $37d2
    tay
_84fe:
    sta $37a9,y
    iny
    cpy #$09
    bcc _84fe
    beq _84fe
    rts

_8509:
    ldx $39cb
    dex
    lda $395d
    and #$0f
    cmp #$0a
    beq _851d
    inx
    cpx #$4c
    bcc _8529
    ldx #$4a
_851d:
    lda $39cb,x
    cmp #$7e
    bne _8529
    lda #$20
    sta $39cb,x
_8529:
    dex
    bne _851d
    rts

_852d:
    ldx $39cb
    cpx #$4c
    bcs _854b
_8534:
    dex
    beq _854a
    lda $39cb,x
    cmp #$7f
    bcs _8542
    cmp #$20
    bcs _8534
_8542:
    lda #$20
    sta $39cb,x
    jmp _8534
_854a:
    clc
_854b:
    rts

_854c:
    ldx $3b35
    bne _858e
    lda $3b25
    beq _855b
_8556:
    sta $3b26
    clc
_855a:
    rts
_855b:
    lda #$00
    sta $3ae7
    sta $3b34
    lda #$70
    ldx #$50
    jsr _823e
    bcs _855a
    jsr _99e0
    bcs _855a
    ldx #$a2
    jsr $3300
    lda $37c2
    cmp #$ff
    bne _857f
    sec
    rts
_857f:
    lda $3b32
    beq _8587
    jmp _86ad
_8587:
    lda $0b02
    cmp #$ff
    beq _8556
_858e:
    lda #$00
    sta $3420
    ldx $3ae7
    ldy $3b23
    beq _859e
    ldy $3b24
_859e:
    lda $3b34
    bne _85d9
    lda $0b02,x
    cmp #$ff
    beq _861b
    cmp #$51
    bcc _85bc
    sec
    sbc #$4f
    sta $3420
_85b4:
    lda #$50
    sta $0b02,x
    sta $37c3
_85bc:
    sta $3b33
_85bf:
    lda $0b02,x
    sta $39cb,y
    inx
    beq _85d1
    iny
    dec $3b33
    bne _85bf
    jmp _85f0
_85d1:
    lda #$ff
    sta $3b34
    jmp _85ea
_85d9:
    lda $0c02,x
    cmp #$ff
    beq _861b
    sta $3b33
_85e3:
    lda $0c02,x
    sta $39cb,y
    inx
_85ea:
    iny
    dec $3b33
    bne _85e3
_85f0:
    lda $3420
    beq _8613
    dex
    ldy $3b34
    bne _8601
_85fb:
    sta $0b02,x
    jmp _8616
_8601:
    cpx #$ff
    bne _860d
    ldy #$00
    sty $3b34
    jmp _85fb
_860d:
    sta $0c02,x
    jmp _8616
_8613:
    dec $3b35
_8616:
    stx $3ae7
    clc
    rts
_861b:
    ldy $37c2
    cpy #$4e
    bcc _8666
    beq _8666
    cpy #$4f
    beq _863f
    tya
    sec
    sbc #$4f
    sta $37c2
    ldy $3b23
    beq _8637
    ldy $3b24
_8637:
    lda #$ff
    sta $3420
    jmp _85b4
_863f:
    sty $3b33
    iny
    sty $0bb4
    ldy $3b23
    beq _864e
    ldy $3b24
_864e:
    ldx #$00
_8650:
    lda $0bb4,x
    sta $39cb,y
    inx
    iny
    dec $3b33
    bne _8650
    lda $37be
    sta $39cb,y
    jmp _8613
_8666:
    iny
    sty $3ac9
    cpy #$02
    bne _8673
    ldy #$fd
    jmp _869c
_8673:
    ldy #$fe
    lda $3b34
    beq _8683
    jmp _8695       ; >?

_867d:              ; ?<
    lda $0b02,x
    sta $39cb,y
_8683:
    inx
    beq _8696
    dey
    dec $37c2
    bne _867d
    jmp _869c

_868f:
    lda $0c02,x
    sta $39cb,y
_8695:
    inx
_8696:
    dey
    dec $37c2
    bne _868f
_869c:
    lda $37be
    sta $39cb,y
    dec $3b35
    lda #$ff
    sta $3b32
    jmp _855b

_86ad:
    lda #$00
    sta $3b32
    lda $0b02
    cmp #$01
    beq _8723
    cmp #$ff
    beq _8723
    ldx $3b23
    beq _86c5
    ldx $3b24
_86c5:
    ldy #$fe
    lda $39cb,y
    sta $3b33
    lda $0b02
    clc
    adc $3b33
    bcs _86dd
    cmp #$53
    bcs _86dd
    jmp _875b
_86dd:
    lda #$50
    sta $39cb,x
    sta $37c3
    inx
    dey
    sec
    sbc $3b33
    sta $3420
    dec $3b33
_86f1:
    lda $39cb,y
    sta $39cb,x
    inx
    dey
    dec $3b33
    bne _86f1
    lda $3420
    sta $3b33
    ldy #$01
_8706:
    lda $0b02,y
    sta $39cb,x
    iny
    inx
    dec $3b33
    bne _8706
    lda $0b02
    sec
    sbc $3420
    dey
    sta $0b02,y
    sty $3ae7
    clc
    rts
_8723:
    ldy #$fe
    lda $39cb,y
    sta $3420
    tya
    sec
    sbc $3420
    tay
    lda $39cc,y
    ldy #$fe
    cmp #$20
    bne _873d
    dec $3ac9
_873d:
    ldx $3b23
    beq _8745
    ldx $3b24
_8745:
    lda $39cb,y
    sta $3b33
_874b:
    lda $39cb,y
    sta $39cb,x
    inx
    dey
    dec $3b33
    bne _874b
    jmp _8788

_875b:
    tay
    dey
    tya
    ldy #$fe
    jmp _8766

_8763:
    lda $39cb,y
_8766:
    sta $39cb,x
    dey
    inx
    dec $3b33
    bne _8763
    lda $0b02
    sta $3b33
    dec $3b33
    ldy #$01
_877b:
    lda $0b02,y
    sta $39cb,x
    iny
    inx
    dec $3b33
    bne _877b
_8788:
    ldx $0b02
    cpx #$ff
    beq _8795
    stx $3ae7
    dec $3b35
_8795:
    clc
    rts

_8797:
    ldx $3ae7
    bne _87ac
    lda #$70
    ldx #$50
    jsr _823e
    bcs _87ab
    ldx $0b02
    stx $3ae7
_87ab:
    rts
_87ac:
    cpx $374c
    bcc _87bc
    lda #$00
    sta $3ae7
    sta $3ae8
    jmp _8797
_87bc:
    lda $0b02,x
    tay
    beq _87cf
    clc
    adc $3ae7
    bcs _87cf
    cmp $374c
    bcc _87d3
    beq _87d3
_87cf:
    lda #$00
    sec
    rts
_87d3:
    sta $3ae7
    inx
    sty $0b02
    ldy #$01
_87dc:
    cpy $0b02
    bcs _87ec
    lda $0b02,x
    sta $0b02,y
    inx
    iny
    jmp _87dc
_87ec:
    lda $374a
    clc
    rts

_87f1:
    ldx $39cb
    inx
    inx
    txa
    clc
    adc $37bd
    sta $37bd
    bcc _880a
    lda #$00
    adc $37bc
    bcs _880b
    sta $37bc
_880a:
    rts
_880b:
    brk
_880c:
.byte $cb,$00

_880e:
    ldy #$00
_8810:
    lda $fd5d,y     ; Read from $fd5d-63
    asl
    bcc _8818
    ora #$01
_8818:
    eor #$ff
    sta $3433,y
    iny
    cpy #$07
    bne _8810
    rts

_8823:
    ldy #$07
_8825:
    lda $fd5c,y     ; Read from $fd5d-63
    sta $3420
    lda _8870,y
    cmp $3420
    bne _8839
    dey
    bne _8825
    jmp _8855
_8839:
    ldy #$00
_883b:
    lda $fd5d,y     ; Read from $fd5d-63
    asl
    bcc _8843
    ora #$01
_8843:
    eor #$ff
    sta $3420
    lda $3433,y
    cmp $3420
    bne _885d
    iny
    cpy #$07
    bne _883b
_8855:
    lda #$00
    sta $3432
    jmp _8865
_885d:
    lda #$ff
    sta $3432
    jmp _8865
_8865:
    ldx #$00
    txa
_8868:
    sta $3433,x
    inx
    cpx #$07
    bne _8868
_8870:
    rts

; Referred to in the block at 8825:
.byte $30,$30,$30,$30,$30,$30,$00

_8878:
    lda #$70
    ldx #$50
    jmp _823e
_887f:
    ldx #$4c
    jsr _8974
    lda #$00
    sta $3940
    rts             ; >?

_888a:
    ldy #$17
    lda ($14),y
    sta $3940
_8891:
    ldx #$4b
    jsr _8974
    lda #$00
    sta $3940
    rts

_889c:
    ldy #$17        ; ?<
    lda ($14),y
    sta $3940       ; >?
_88a3:
    lda #$01
_88a5:
    sta $3941
    sta $3942
    ldx #$4f
    jsr _8974
    lda #$5b
    sta $3943
    lda #$39
    sta $3944
    ldx #$55
    jsr _8974
    jmp _9b5c

_88c2:
    lda #$5b        ; ?<
    sta $3943
    lda #$39
    sta $3944
    ldx #$52
    jmp _8971

_88d1:
    lda #$cb
    sta $3943
    lda #$39
    sta $3944
    ldx #$52
    jmp _8971

_88e0:
    jsr _88f9
    ldy #$17
    lda ($14),y
    sta $3940
_88ea:
    lda #$5b
    sta $3943
    lda #$39
    sta $3944
    ldx #$54
    jmp _8974

_88f9:
    ldy #$17       ; *
    lda ($14),y
    sta $3940
_8900:
    lda #$01
    sta $3941
    sta $3942
    ldx #$4f
    jmp _8974

_890d:
    ldy #$17
    lda ($14),y
    sta $3940
    lda #$00
    sta $3941
    lda #$01
    sta $3942
    ldx #$50
    jsr _8974
    lda $3941
    ora $3942
    sec
    beq _8950
    ldy #$17
    lda ($14),y
    sta $3940
    lda #$cb
    sta $3943
    lda #$39
    sta $3944
    ldx #$55
    jsr _8974
    ldy #$18
    lda $3941
    sta ($14),y
    iny
    lda $3942
    sta ($14),y
    clc
_8950:
    rts

_8951:
    lda #$00
    sta $3941
    lda #$01
    sta $3942
    ldx #$50
    jsr _8974
    rts

_8961:
    lda #$00
    sta $3941
    lda #$ff
    sta $3942
    ldx #$50
    jsr _8974
    rts             ; >?

_8971:
    sec
    bcs _8975
_8974:
    clc
_8975:
    stx $393e
    lda #$aa
    sta $3945
    lda #$3f
    ldy #$39
    php
    jsr $3300
    plp
    lda $3949
    beq _8990
    bcs _8990
    brk
_898e:
.byte $83,$00
_8990:
    cmp #$01
    rts

_8993:
    lda #$00        ; ?<
    sta $394f
    lda #$41
    sta $3950
    lda #$39
    sta $3951
    ldx #$42
    jmp _89f8

_89a7:
    lda #$02
    sta $394f
    jmp _89b4

_89af:
    lda #$00
    sta $394f
_89b4:
    lda #$5b
    sta $3950
    lda #$39
    sta $3951
    ldx #$41
    jmp _89f8

_89c3:
    lda #$02
    sta $394f
    jmp _89d0

_89cb:
    lda #$00
    sta $394f
_89d0:
    ldx #$43
    jmp _89f8

_89d5:
    lda $fd1e
    sta $394f
    jmp _89e3

_89de:
    lda #$03
    sta $394f
_89e3:
    ldx #$40
    jmp _89f8

_89e8:
    lda $fd1e
    sta $394f
    jmp _89f6

_89f1:
    lda #$03
    sta $394f
_89f6:
    ldx #$44
_89f8:
    stx $394d
    txa
    pha
    ldy #$ee
    jsr _9848
    ldy #$ff
    tya
    jsr _9856
    pla
    tax
    lda #$1b
    sta $394e
    lda #$4e
    ldy #$39
    jsr $3300
    pha
    ldy #$ee
    jsr _9856
    pla
    cmp #$01
    rts

_8a20:
    ldx #$03
    stx $2d
    ldx #$20
    jsr $3300
    inc $3958
    lda $3b03
    beq _8a34
    dec $3b03
_8a34:
    jsr _8a6c
    lda #$02
    sta $392a
_8a3c:
    ldy $392a
    lda _8ab2,y
    sta $10
    lda _8ab3,y
    sta $11
    beq _8a20
    iny
    iny
    sty $392a
    ldy #$1b
    lda ($10),y
    beq _8a3c
    cmp #$ff
    beq _8a3c
    sec
    sbc #$01
    sta ($10),y
    bne _8a3c
    lda $3419
    ora #$01
    sta $3419
    jmp _8a3c       ; >?

_8a6c:
    lda #$e8
    sta $392e
    lda #$03
    sta $392f
    lda #$00
    sta $3930
    ldx #$03
    stx $2d
    lda #$2e
    ldy #$39
    ldx #$24
    jmp $3300

_8a88:
    jsr _8a6c
    lda #$00
    sta $392a
_8a90:
    ldy $392a
    lda _8ab2,y
    sta $10
    lda _8ab3,y
    sta $11
    beq _8ab1
    lda #$00
    ldy #$1b
_8aa3:
    sta ($10),y
    dey
    bpl _8aa3
    inc $392a
    inc $392a
    jmp _8a90
_8ab1:
    rts

_8ab2: .byte $2f
_8ab3: .byte    $36
.byte        $4b,$36
.byte        $67,$36
.byte        $83,$36
.byte        $9f,$36
.byte        $bb,$36
.byte        $d7,$36
.byte        $f3,$36
.byte        $0f,$37
.byte        $2b,$37
.byte        $00,$00

_8ac8:
    and #$01        ; ?<
    eor $392c
    bne _8adc
_8acf:
    lda #$01
    ldx #$cb
    stx $2d
    ldy #$39
    ldx #$8e
    jsr $3300
_8adc:
    rts

_8add:
    lda $392c
    bne _8aef
_8ae2:
    lda #$00
    ldx #$cb
    stx $2d
    ldy #$39
    ldx #$8e
    jsr $3300
_8aef:
    rts

_8af0:
    jsr _8c3f
    bcs _8b0c
    ror
    bcc _8afa
    bvc _8b10
_8afa:
    ror
    bcs _8b26
    bvc _8b0c
    lda $fdea
    bne _8b26
    lda $3418
    and #$df
    sta $3418
_8b0c:
    lda #$00
    clc
    rts

_8b10:
    jsr _8c8e
    ora #$10
    sta $3418
    ldx #$04
    stx $2d
    lda #$01
    ldx #$27
    jsr $3300
    lda #$01
    rts

_8b26:
    lda $3419
    and #$20
    beq _8b44
    lda $3418
    and #$7f
    ora #$08
    sta $3418
    ldx #$05
    stx $2d
    lda #$01
    ldx #$27
    jsr $3300
    lda #$02
_8b44:
    rts

_8b45:
    tax
    jsr _8c8e
    and #$10
    bne _8b50
_8b4d:
    brk
_8b4e:
.byte $90,$00
_8b50:
    cpx #$01
    bne _8b62
    lda #$ff
    sta $3751
    jsr _8b9c
    jsr _8c97
    jmp _8b7e
_8b62:
    cpx #$02
    beq _8b6a
    cpx #$03
    bne _8b4d
_8b6a:
    lda $362b
    sta $3751
    jsr _8b94
    jsr _8d43
    lda $3752
    bne _8b7e
    jsr _809f
_8b7e:
    lda $3418
    and #$ee
    ora #$80
    sta $3418
    ldx #$04
    stx $2d
    ldx #$20
    jsr $3300
    jmp _8b45
_8b94:
    lda #$00
    sta $3959
    jmp _8096
_8b9c:
    lda #$ff
    sta $3959
    rts

_8ba2:
    ldx #$00
    stx $374a
    tax
    jsr _8c8e
    and #$08
    bne _8bb2
    brk
_8bb0:
.byte $86,$00
_8bb2:
    cpx #$01
    bne _8bbf
    jsr _8b9c
    jsr _9165
    jmp _8be7

_8bbf:
    cpx #$02
    bne _8bcc
    jsr _8b94
    jsr _91ef
    jmp _8bdf

_8bcc:
    cpx #$04
    bne _8bdc
    jsr _8b94
    jsr _8120
    jsr _927c
    jmp _8bdf
_8bdc:
    brk
_8bdd:
.byte $87,$00
_8bdf:
    lda #$00
    sta $362f
    jsr _809f
_8be7:
    lda $3418
    and #$f7
    ora #$80
    sta $3418
    ldx #$05
    stx $2d
    ldx #$20
    jsr $3300
    jmp _8ba2

_8bfd:
    lda $3419
    and #$fe
    sta $3419
    lda #$00
    pha
    jmp _8c14       ; >?

_8c0b:
    lda #$02
    pha
    jmp _8c14
_8c11:
    lda #$01
    pha
_8c14:
    jsr _807d
    lda $3418
    and #$e7
    ldx $3b06
    bne _8c23
    and #$fe
_8c23:
    ora #$80
    sta $3418
    ldx #$00
    stx $3b06
    jsr _807d
    ldx #$07
    stx $2d
    lda #$01
    ldx #$27
    jsr $3300
    pla
    cmp #$01
    rts

_8c3f:
    lda $3419       ; ?<
    and #$18
    bne _8c8a
    ldx #$00
    lda #$01
    bit $3418
    beq _8c62
    inx
    lda $3b06
    beq _8c62
    ldx #$06
    stx $2d
    lda #$01
    ldx #$27
    jsr $3300
    ldx #$01
_8c62:
    lda #$80
    bit $3418
    beq _8c8a
    lda $fdea
    beq _8c7c
    lda $3b03
    bne _8c7c
    lda $3419
    and #$01
    beq _8c7c
    inx
    inx
_8c7c:
    lda #$20
    bit $3418
    clv
    beq _8c87
    bit $3929
_8c87:
    txa
    clc
    rts

_8c8a:
    lda #$00
    sec
    rts

_8c8e:
    lda $3418
    and #$7f
    sta $3418
    rts

_8c97:
    jsr _8182
    ldx #$fa
    lda #$96
    ldy #$00
    jsr _8cdd
    bcs _8cd1
    lda $362b
    cmp #$00
    bne _8cc2
    lda #$0e
    ldy #$06
    ldx #$cd
    jsr _8cdd
    bcs _8cd1
    ldx #$fa
    lda #$f4
    ldy #$01
    jsr _8cdd
    bcs _8cd1
_8cc2:
    lda $362b
    cmp #$00
    bne _8cce
    ldx #$96
    jsr $3300
_8cce:
    jmp _8d43

_8cd1:
    ldx #$12
    stx $2d
    ldx #$04
    jsr $3300
    jmp _8c11

_8cdd:
    pha
    lda #$ff
    sta $3b07
    pla
    sta $3b0f
    sty $3b10
    lda #$00
    sta $3b11
    stx $3b1c
    lda #$ff
    tay
    ldx #$1d
    jsr _8d31
    ldx #$0d
    stx $2d
    ldx #$26
    jsr $3300
    lda #$0f
    ldy #$3b
    ldx #$0d
    stx $2d
    ldx #$22
    jsr $3300
    php
    lda #$0f
    ldy #$3b
    ldx #$25
    jsr $3300
    plp
    bcs _8d2b
    sec
    bpl _8d2b
    ldx #$1e
    jsr _8d31
    lda $3b18
    cmp $3b1c
_8d2b:
    lda #$00
    sta $3b07
    rts
_8d31:
    stx $3b17
    sta $3b1a
    sty $3b1b
    lda #$81        ; OSWORD &81 - see IC24-SK1
    ldx #$15
    ldy #$3b
    jmp OSWORD

_8d43:
    lda $3b08
    sta $3b0a
    jsr _8187
    lda #$00
    sta $3aeb
    sta $379e
    jsr _8096
    lda #$ff
    sta $3432
    lda $3b0c
    bne _8d67
    jsr _84e9
    jsr _8439
_8d67:
    lda #$00
    sta $3b0c
    lda $374a
    cmp #$50
    beq _8d7b
    jsr _818c
    lda #$0a
    jmp _90e8
_8d7b:
    jsr _99bb
    bcs _8dc7
    jsr _82c8
    lda $392d
    beq _8d92
    jsr _89de
    bcc _8d92
    lda #$00
    sta $392d
_8d92:
    lda $fd1e
    beq _8da6
    jsr _89d5
    bcc _8da6
    jsr _81b4
    lda #$0b
    ldx #$06
    jmp _90e3
_8da6:
    lda #$03
    ora $3b0a
    sta $3797
    lda $392d
    ora #$0d
    sta $3796
    jsr _8360
    bcc _8dcf
    lda $379e
    beq _8dc7
    lda $374a
    cmp #$fe
    beq _8dcf
_8dc7:
    jsr _8196
    lda #$0c
    jmp _90e8
_8dcf:
    lda $379e
    beq _8df5
    ldx #$a4
    jsr $3300
_8dd9:
    jsr _9b3f
    bcc _8deb
    lda #$01
    sta $37a2
    jsr _845f
    bcc _8dd9
_8de8:
    jmp _8dc7
_8deb:
    lda #$00
    sta $37a2
    jsr _8458
    bcs _8de8
_8df5:
    lda #$03
    bit $3b38
    bmi _8dfe
    lda #$04
_8dfe:
    sta $393f
    ldx #$47
    jsr _8971
    lda #$00
    ror
    eor #$80
    sta $3aeb
    lda $379e
    bne _8e37
    lda $374c
    cmp #$66
    beq _8e24
_8e1a:
    jsr _8196
    lda #$0d
    ldx #$02
    jmp _90e3
_8e24:
    ldx $0b02
    cpx #$66
    bne _8e1a
_8e2b:
    lda $0b01,x
    sta $395a,x
    dex
    bne _8e2b
    jmp _8e5f
_8e37:
    jsr _99e0
    bcs _8e1a
    ldx #$9e
    jsr $3300
    lda $3b1d
    cmp #$ff
    beq _8e1a
    lda $37c1
    bne _8e57
    lda $3b1d
    cmp #$f8
    beq _8e5f
    jmp _8e1a
_8e57:
    jsr _8878
    bcc _8e37
    jmp _9008
_8e5f:
    jsr _9b5c
    bcs _8e1a
    lda $3432
    beq _8e85
    lda #$70
    bit $395d
    beq _8e73
    jmp _8e7a
_8e73:
    lda #$03
    bit $395c
    beq _8e85
_8e7a:
    jsr _81d2
    sec
    lda #$16
    ldx #$08
    jmp _90e3
_8e85:
    lda $395c
    ora #$40
    sta $395c
    lda $392d
    ora $fd1e
    bne _8ead
    lda $395d
    and #$0f
    cmp #$0a
    beq _8ea3
    lda $3aeb
    bne _8ecc
_8ea3:
    jsr _81b9
    lda #$0e
    ldx #$07
    jmp _90e3
_8ead:
    lda #$01
    sta $394b
    sta $394c
    jsr _90c8
    jsr _89af
    bcc _8ec7
    jsr _81b9
    lda #$0f
    ldx #$07
    jmp _90e3
_8ec7:
    lda $3aeb
    beq _8eff
_8ecc:
    lda $379e
    bne _8edc
    ldx $3965
    lda $395b,x
    ora #$10
    sta $395b,x
_8edc:
    lda $395d
    and #$0f
    cmp #$0a
    bne _8eed
    lda $392c
    beq _8ef2
    jmp _8ea3
_8eed:
    jsr _88c2
    bcc _8eff
_8ef2:
    jsr _887f
    lda #$00
    sta $3aeb
    bit $3b38
    bmi _8ea3
_8eff:
    jsr _81a0
_8f02:
    lda $379e
    bne _8f0a
    jmp _8f59
_8f0a:
    lda $3b21
    beq _8f1c
    ldx #$a0
    jsr $3300
    lda $3b21
    beq _8f1c
    jmp _8fb2
_8f1c:
    lda $3b23
    cmp #$10
    beq _8f34
    cmp #$30
    beq _8f34
    jsr _854c
    bcc _8f2f
    jmp _9008
_8f2f:
    lda $3b26
    bne _8f43
_8f34:
    ldx #$9d
    jsr $3300
    lda $3b23
    cmp #$20
    beq _8f1c
    jmp _8fb2
_8f43:
    lda $3b23
    bne _8f4b
    jmp _9017
_8f4b:
    lda $3b24
    sta $39cb
    lda #$00
    sta $3b23
    jmp _8fb2

_8f59:
    jsr _8797
    bcc _8f63
    lda #$10
    jmp _90e8
_8f63:
    lda $0b02
    bne _8f6b
    jmp _9001
_8f6b:
    jsr _8324
    lda #$10
    bit $395c
    beq _8f7c
    lda #$02
    bit $395c
    bne _8fbb
_8f7c:
    lda $395d
    and #$0f
    cmp #$0a
    bne _8fa1
    ldx $39cb
    cpx #$86
    bcs _9008
    jsr _8534
    bcs _9008
    jsr _8509
    lda #$cb
    sta $3943
    lda #$39
    sta $3944
    jmp _8fd8
_8fa1:
    lda #$01
    jsr _8ac8
    lda #$10
    bit $395c
    bne _8fb2
    jsr _852d
    bcs _9008
_8fb2:
    jsr _8509
    jsr _8ae2
    jmp _8fbe
_8fbb:
    jsr _8add
_8fbe:
    lda $379e
    beq _8fc6
    jsr _87f1
_8fc6:
    lda $3aeb
    beq _8fd8
    jsr _88d1
    bcc _8fd8
    jsr _887f
    lda #$00
    sta $3aeb
_8fd8:
    lda $392d
    ora $fd1e
    beq _8ffe
    lda $395d
    and #$0f
    cmp #$0a
    beq _8fec
    jsr _8acf
_8fec:
    jsr _90b6
    jsr _8993
    bcc _8ffe
    jsr _81b9
    lda #$12
    ldx #$07
    jmp _90e3
_8ffe:
    jmp _8f02

_9001:
    lda $0b03
    cmp #$01
    beq _9012
_9008:
    jsr _81aa
    lda #$15
    ldx #$01
    jmp _90e3
_9012:
    lda $0b04
    bne _9008

_9017:
    lda $392d
    ora $fd1e
    beq _902e
    jsr _89cb
    bcc _902e
    jsr _81b9
    lda #$11
    ldx #$07
    jmp _90e3
_902e:
    lda $379e
    beq _9065
    lda $3aeb
    beq _904a
    lda $37bd
    sta $39be
    lda $37bc
    sta $39bf
    jsr _8900
    jsr _88ea
_904a:
    lda #$fd
    ldx #$50
    jsr _823e
    bcc _9056
    jmp _9074
_9056:
    jsr _90d5
    jsr _846d
    bcc _9086
    cmp #$fe
    bne _9074
    jmp _8dcf
_9065:
    jsr _8797
    bcs _9070
    jsr _90d5
    jmp _8df5
_9070:
    cmp #$90
    beq _9086
_9074:
    jsr _81aa
    lda #$13
    ldx $379e
    beq _9083
    ldx #$00
    jmp _90e3
_9083:
    jmp _90e8
_9086:
    jsr _81be
    jsr _8865
    jsr _9127
    jsr _8421
    bcc _9097
    jsr _829a
_9097:
    lda $379e
    bne _90b3
    jsr _90d5
    lda $3b0a
    beq _90b3
    jsr _81cd
    jsr _810f
    jsr _9418
    jsr _8120
    jsr _809f
_90b3:
    jmp _8c11

_90b6:
    lda $394c
    cmp #$34
    bcc _90c5
    inc $394b
    lda #$00
    sta $394c
_90c5:
    inc $394c
_90c8:
    lda $394b
    sta $3941
    lda $394c
    sta $3942
    rts

_90d5:
    lda $3aeb
    beq _90e2
    jsr _8891
    lda #$00
    sta $3aeb
_90e2:
    rts

_90e3:
    pha
    jsr _8412
    pla
_90e8:
    sta $3b04
    lda $374a
    cmp #$b0
    bne _90fc
    lda $3b04
    cmp #$0a
    beq _90fc
    jsr _81a5
_90fc:
    lda $3aeb
    beq _9111
    lda $3b04
    cmp #$13
    beq _910e
    jsr _887f
    jmp _9111
_910e:
    jsr _8891
_9111:
    jsr _9127
    lda $374a
    cmp #$c0
    bne _911e
    jsr _8143
_911e:
    jsr _9138
    jsr _829a
    jmp _8c0b

_9127:
    lda $392d
    beq _912f
    jsr _89f1
_912f:
    lda $fd1e
    beq _9137
    jsr _89e8
_9137:
    rts

_9138:
    lda $374a
    cmp #$80
    bne _915d
    lda $379e
    beq _9149
    ldx #$00
    jmp _9156
_9149:
    lda $3429
    tax
    beq _915d
    dex
    cpx #$08
    bcc _9156
    ldx #$00
_9156:
    lda _915e,x
    tax
    jmp _812d
_915d:
    rts

_915e:
.byte $1a,$16,$15,$17,$1b,$1a,$1a

_9165:
    jsr _9864
    bcc _916d
    jmp _91eb
_916d:
    cpy #$00
    beq _9174
    jmp _9178
_9174:
    jmp _8bfd

_9177:
    rts

_9178:
    sta $14
    sty $15
    jsr _98b7
    bcc _9184
    jmp _8bfd
_9184:
    ldx #$00
    ldy #$00
    clv
_9189:
    cpx #$1f
    bcs _91b8
    lda $3ac8,x
    cmp #$3b
    beq _91bb
    cmp #$20
    beq _91b4
    cmp #$30
    bcc _91a0
    cmp #$3a
    bcc _91ad
_91a0:
    cmp #$58
    beq _91a8
    cmp #$78
    bne _91b4
_91a8:
    bvs _91b8
    bit $3929
_91ad:
    cpy #$16
    bcs _91b8
    sta ($14),y
    iny
_91b4:
    inx
    jmp _9189
_91b8:
    brk
_91b9:
.byte $88,$00
_91bb:
    lda #$20
_91bd:
    cpy #$16
    bcs _91c7
    sta ($14),y
    iny
    jmp _91bd
_91c7:
    ldy #$17
    lda $3940
    sta ($14),y
    ldy #$1a
    lda #$00
    sta ($14),y
    jsr _969c
    lda $3ac8
    eor #$2d
    cmp #$01
    ldy #$16
    lda ($14),y
    and #$7f
    bcc _91e8
    eor #$80
_91e8:
    sta ($14),y
    rts

_91eb:
    sta $14
    sty $15
_91ef:
    jsr _89de
    bcc _91fa
    jsr _8129
    jmp _8c11
_91fa:
    jsr _889c
    bcc _9202
    brk
_9200:
.byte $89,$00
_9202:
    jsr _98db
    bcc _920a
    brk
_9208:
.byte $8a,$00
_920a:
    lda $3994,x
    bpl _9212
    brk
_9210:
.byte $8b,$00
_9212:
    lda $3418
    and #$20
    beq _9226
    lda $3418
    and #$bf
    eor #$00
    sta $3418
    jmp _9262
_9226:
    ldy #$1b
    lda ($14),y
    cmp #$ff
    bne _923e
    lda $3418
    and #$bf
    eor #$00
    sta $3418
    jmp _9262
_923b:
    brk
_923c:
.byte $8c,$00
_923e:
    ldy #$1b
    lda ($14),y
    bne _923b
    lda $3418
    and #$bf
    eor #$40
    sta $3418
    lda $395c
    and #$10
    beq _925a
    lda #$00
    jmp _925c
_925a:
    lda #$ff
_925c:
    sta $379e
    sta $37d1
_9262:
    jsr _88ea
    jsr _926b
    jmp _927c

_926b:
    jsr _98db
    txa
    clc
    adc #$39
    sta $3965
    lda $395a
    sta $3966
    rts

_927c:
    lda $3418
    and #$08
    bne _9286
    brk
_9284:
.byte $8e,$00
_9286:
    lda #$00
    sta $392c
    jsr _84a7
    jsr _84de
    jsr _84e9
    jsr _958c
    bcc _92a4
    jsr _9596
    bcs _92a1
    jsr _8120
_92a1:
    jmp _933e
_92a4:
    lda $3959
    beq _92cb
    jsr _813b
    jsr _8096
    lda #$ff
    sta $3b06
    jsr _9418
    bcs _92c3
    lda #$00
    sta $3b06
    jsr _80a8
    bcs _92cb
_92c3:
    jsr _8120
    lda #$ff
    jmp _95db
_92cb:
    jsr _8120
    lda $3959
    beq _92dd
    jsr _842f
    bcc _92dd
    lda #$32
    jmp _95db
_92dd:
    jsr _8148
    jsr _8336
    bcc _92f5
    jsr _8865
    jsr _814d
    lda #$00
    sta $379e
    lda #$34
    jmp _95db
_92f5:
    jsr _8865
    ldx #$a3
    jsr $3300
    lda $379e
    bne _9311
    jsr _9a3d
    bcc _9314
    jsr _815c
    lda #$3b
    ldx #$03
    jmp _95d6
_9311:
    jsr _84de
_9314:
    jsr _9a0e
    bcc _9323
    jsr _8157
_931c:
    lda #$33
    ldx #$04
    jmp _95d6
_9323:
    lda $379e
    beq _933e
    jsr _8451
    bcc _9339
    jsr _816b
    jmp _931c
_9333:
    jsr _8170
    jmp _931c
_9339:
    jsr _9b36
    bcs _9333
_933e:
    ldy $3965
    lda $395b,y
    and #$9f
    sta $395b,y
    lda $3418
    and #$60
    ora $395b,y
    sta $395b,y
    lda $39b9
    cmp #$54
    bne _9367
    lda $395c
    and #$10
    bne _9367
    lda #$2d
    sta $39b9
_9367:
    jsr _9bc0
    jsr _958c
    bcc _9386
    jsr _89a7
    bcc _9379
_9374:
    lda #$39
    jmp _95db
_9379:
    jsr _89c3
    bcs _9374
    jsr _89af
    bcs _9374
    jmp _93a7
_9386:
    jsr _8161
    jsr _836a
    bcc _9396
    jsr _816b
    lda #$36
    jmp _95db
_9396:
    ldy $3965
    lda $395b,y
    sta $3ae9
    ora #$10
    sta $395b,y
    jsr _88e0

_93a7:
    jsr _88f9
_93aa:
    jsr _890d
    bcc _93b2
    jmp _93e3
_93b2:
    lda #$00
    jsr _8ac8
    jsr _958c
    bcc _93ce
    lda #$ff
    jsr _8ac8
    jsr _8993
    bcc _93cb
_93c6:
    lda #$35
    jmp _95db
_93cb:
    jmp _93aa
_93ce:
    lda $379e
    beq _93d6
    jsr _8474
_93d6:
    jsr _83b0
    bcc _93aa
_93db:
    jsr _816b
    lda #$37
    jmp _95db

_93e3:
    jsr _958c
    bcc _93f0
    jsr _89cb
    bcs _93c6
    jmp _945e
_93f0:
    lda $379e
    beq _9404
    lda #$ff
    sta $39cb
    lda #$01
    sta $374d
    jsr _83b0
    bcs _9413
_9404:
    jsr _83dc
    bcs _93db
    lda $379e
    bne _9449
    jsr _8393
    bcc _9456
_9413:
    lda #$38
    jmp _95db       ; >?

_9418:
    lda #$e8
    sta $3936
    lda #$03
    sta $3937
    lda #$00
    sta $3938
    ldx #$06
    stx $2d
    ldx #$26
    jsr $3300
    lda #$36
    ldy #$39
    ldx #$06
    stx $2d
    ldx #$22
    jsr $3300
    php
    lda #$36
    ldy #$39
    ldx #$25
    jsr $3300
    plp
    rts

_9449:
    jsr _8466       ; ?<
    bcs _9413
    lda $37ae
    ora $37af
    bne _9413
_9456:
    jsr _817d
    lda #$00
    sta $39b8
_945e:
    ldy $3965
    lda $395b,y
    ora #$90
    sta $395b,y
    jsr _88e0
    jsr _81ea
    jsr _9bc0
    jsr _820b
    lda #$00
    sta $3b0e
    jsr _958c
    bcs _94a7
    jsr _95b4
    bcc _94a4
    jsr _8178
    ldx #$05
    jsr _8412
    jsr _829a
    lda #$ff
    sta $3b0e
_9494:
    ldx #$1f
    jsr $3300
    jsr _89de
    jsr _95b4
    bcs _9494
    jsr _817d
_94a4:
    jsr _89c3
_94a7:
    lda #$00
_94a9:
    pha
    jsr _9969
    pla
    bvs _94c3
    pha
    tax
    lda $3994,x
    and #$80
    cmp #$01
    pla
    bcc _94e2
    clc
    adc #$01
    cmp #$06
    bcc _94a9
_94c3:
    jsr _88e0
    lda #$05
    sta $393f
    ldy #$17
    lda ($14),y
    sta $3940
    ldx #$4d
    jsr _8971
    lda $3949
    beq _94e2
    jsr _887f
    jmp _94e5
_94e2:
    jsr _8891
_94e5:
    lda $379e
    bne _9537
    ldx #$05
_94ec:
    lda $3994,x
    and #$0f
    pha
    dex
    bpl _94ec
    lda $39b8
    pha
    jsr _98b7
    bcs _9530
    ldy #$17
    lda $3940
    sta ($14),y
    jsr _926b
    pla
    sta $39b8
    ldx #$00
_950e:
    lda $3994,x
    and #$f0
    sta $3994,x
    pla
    ora $3994,x
    sta $3994,x
    inx
    cpx #$06
    bcc _950e
    lda $3b0e
    bne _952a
    jmp _933e
_952a:
    jsr _89f1
    jmp _8c11
_9530:
    pla
    pla
    pla
    pla
    pla
    pla
    pla
_9537:
    jsr _9596
    bcc _9544
    lda $fdea
    bne _9544
    jsr _81c8
_9544:
    lda #$00
    ldy #$00
    sta ($14),y
    lda $3419
    ora #$01
    sta $3419
    jsr _89f1
    lda $3b0e
    bne _9589
    jsr _958c
    bcs _9589
    jsr _959e
    jsr _8428
    tax
    cmp #$a0
    beq _9589
    lda $3b0b
    beq _9589
    cpx #$50
    bne _9589
    lda $3418
    and #$f7
    ora #$80
    sta $3418
    lda #$ff
    sta $3b0c
    jsr _97f9
    jsr _809f
    rts
_9589:
    jmp _8c11
_958c:
    lda $3418
    and #$40
    eor #$40
    cmp #$01
    rts

_9596:
    lda $3418
    and #$20
    cmp #$01
    rts

_959e:
    lda $3b0b
    lsr
    lsr
    and #$03
    tax
    lda _95b0,x
    sta $3b0d
    sta $3752
    rts
_95b0:
    brk
_95b1:
.byte $02,$06,$14

_95b4:
    lda $3ae9
    and #$10
    sta $3ae9
    ldy $3965
    lda $395b,y
    pha
    and #$ef
    eor $3ae9
    sta $395b,y
    jsr _89a7
    pla
    ldy $3965
    sta $395b,y
    rts

_95d6:
    pha
    jsr _8412
    pla
_95db:
    sta $39b8
    lda $3421
    sta $3aec
    lda $3747
    sta $3aed
    lda $374a
    sta $3aee
    jsr _96af
    lda $379e
    beq _95fb
    jsr _84de
_95fb:
    jsr _958c
    bcs _961c
    lda $374a
    cmp #$b0
    bne _9611
    lda $39b8
    cmp #$34
    beq _9611
    jsr _8166
_9611:
    lda $374a
    pha
    jsr _829a
    pla
    sta $374a
_961c:
    jsr _89f1
    lda $39b8
    cmp #$ff
    bne _9629
    jmp _8c0b
_9629:
    lda $374a
    cmp #$c0
    bne _9638
    jsr _8143
    lda #$01
    sta $39b8
_9638:
    jsr _96e1
    jsr _89de
    bcs _9650
    jsr _9bc0
    jsr _88e0
    jsr _89a7
    bcs _9650
    jsr _89c3
    bcc _9653
_9650:
    jsr _8178
_9653:
    jsr _89f1
    lda $14
    cmp #$2f
    bne _9665
    lda $15
    cmp #$36
    bne _9665
    jsr _888a
_9665:
    ldy #$1a
    lda ($14),y
    cmp #$04
    bcc _9683
    ldy #$1b
    lda #$ff
    sta ($14),y
    ldy $3965
    lda $395b,y
    and #$9f
    eor #$00
    sta $395b,y
    jmp _8c0b
_9683:
    lda $3418
    and #$20
    bne _9694
    lda ($14),y
    clc
    adc #$01
    sta ($14),y
    jsr _969c
_9694:
    jmp _8c0b

_9697:
.byte $00,$1e,$2a,$3c,$b4

_969c:
    ldy #$1a
    lda ($14),y
    tax
    lda #$ff
    cpx #$05
    bcs _96aa
    lda _9697,x
_96aa:
    ldy #$1b
    sta ($14),y
    rts

_96af:
    ldx #$39
    lda $3aec
    jsr _96c4
    lda $3aed
    jsr _96c4
    lda $3aee
    jsr _96c4
    rts

_96c4:
    jsr _96cb
    lsr
    lsr
    lsr
    lsr
_96cb:
    pha
    lda $395b,x
    and #$f0
    sta $395b,x
    pla
    pha
    and #$0f
    ora $395b,x
    sta $395b,x
    inx
    pla
    rts

_96e1:
    lda $374a
    cmp #$80
    bne _9706
    lda $379e
    beq _96f2
    ldx #$00
    jmp _96ff
_96f2:
    lda $3429
    tax
    beq _9706
    dex
    cpx #$08
    bcc _96ff
    ldx #$00

_96ff:
    lda _9707,x
    tax
    jmp _812d
_9706:
    rts
_9707:
.byte $0c,$07,$0c,$0c,$0c,$0d,$0d,$0f   ; >?

_970f:       ; RAM entry point 6
    lda $3418
    and #$80
    bne +
    jmp _9841
*
    lda $fdea
    beq _972f
    lda $3418
    ora #$20
    sta $3418
    lda $3419
    ora #$01
    sta $3419
    rts
_972f:
    jmp _9839

_9732:       ; RAM entry point 9
    lda $3418
    and #$80
    bne +
    jmp _9841
*
    lda $3418
    and #$7f
    ora #$08
    sta $3418
    jsr _8096
    ldx #$15
_974b:
    lda $35ee,x
    sta $376a,x
    dex
    bpl _974b
    jsr _8432
    bcc +
    jmp _8c0b
*
    jsr _81cd
    jsr _810f
    jsr _9418
    jsr _8120
    jsr _809f
    jsr _829a
    jmp _8c11

_9771:       ; RAM entry point 4
    lda $3418
    and #$80
    sec
    bne _977c
    jmp _9816
_977c:
    lda $3418
    and #$7f
    ora #$08
    and #$bf
    eor #$40
    sta $3418
    ldx #$15
_978c:
    lda $35ee,x
    sta $3ac8,x
    dex
    bpl _978c
    lda #$3b
    sta $3ade
    jsr _9931
    bcs _97b8
    sta $14
    sty $15
    lda #$00
    ldy #$1a
    sta ($14),y
    ldy #$1b
    sta ($14),y
    ldx #$05
    stx $2d
    lda #$02
    ldx #$27
    jmp $3300
_97b8:
    ldx #$15
_97ba:
    lda $35ee,x
    sta $362f,x
    dex
    bpl _97ba
    lda #$2f
    sta $14
    lda #$36
    sta $15
    jsr _98b7
    bcc _97d8
    lda #$00
    sta $362f
    jmp _9839
_97d8:
    lda $3940
    sta $3646
    jsr _89de
    bcc _97ee
    jsr _888a
    lda #$00
    sta $362f
    jmp _8c0b
_97ee:
    ldx #$05
    stx $2d
    lda #$04
    ldx #$27
    jmp $3300

_97f9:       ; RAM entry point 5
    lda $3418
    and #$80
    clc
    beq _9816
    lda $3418
    and #$7f
    ora #$10
    sta $3418
    ldx #$04
    stx $2d
    lda #$02
    ldx #$27
    jmp $3300
_9816:
    lda $3b07
    beq _9836
    php
    ldx #$0d
    stx $2d
    lda #$01
    ldx #$27
    jsr $3300
    ldx #$07
    stx $2d
    ldx #$21
    jsr $3300
    plp
    bcc _97f9
    jmp _9771
_9836:
    jmp _9841

_9839:
    lda #$01
    sta $35ec
    jmp _8c0b

_9841:
    lda #$02
    sta $35ec
    rts

_9847:
    rts
_9848:
    ldx $3b05
    beq _9847
    ldx #$21
    stx $2d
    ldx #$13
    jmp $3300

_9856:
    ldx $3b05
    beq _9847
    ldx #$22
    stx $2d
    ldx #$13
    jmp $3300

_9864:
    lda #$00        ; ?<
    sta $392a
    ldx #$00
_986b:
    inc $392a
    inc $392a
    ldy $392a
    lda _8ab2,y
    sta $10
    lda _8ab3,y
    sta $11
    beq _98a0
    ldy #$00
    lda ($10),y
    bne _988c
    ldx $392a
    jmp _986b
_988c:
    lda $3418
    and #$20
    bne _98ae
    ldy #$1b
    lda ($10),y
    beq _98b1
    cmp #$ff
    beq _98b1
    jmp _986b
_98a0:
    lda _8ab2,x
    ldy _8ab3,x
    cpx #$00
    bne _98ac
    ldy #$00
_98ac:
    clc
    rts
_98ae:
    jsr _81c3
_98b1:
    lda $10
    ldy $11
    sec
    rts         ; >?

_98b7:
    lda #$03
    sta $393f
    ldx #$48
    jsr _8971
    bcs _98d1
_98c3:
    lda $3949
    bne _98ce
    jsr _98db
    bcs _98d3
    rts
_98ce:
    jsr _8891
_98d1:
    sec
    rts
_98d3:
    ldx #$49
    jsr _8971
    jmp _98c3

_98db:
    jsr _88a3
    bcc _98e3
    brk
_98e1:
.byte $8d,$00
_98e3:
    ldy #$00
_98e5:
    sty $392b
    lda $3994,y
    and #$80
    bne _9922
    lda $392b
    jsr _992c
    bvs _992a
    inc $3b3a
    bcc _990b
    pha
    ldx #$00
    lda ($14,x)
    cmp #$01
    pla
    bcs _9922
    ldx $392b
    clc
    rts
_990b:
    pha
    ldx #$00
    lda ($14,x)
    cmp #$01
    pla
    bcc _9922
    cmp $14
    bne _9922
    cpy $15
    bne _9922
    ldx $392b
    clc
    rts
_9922:
    ldy $392b
    iny
    cpy #$06
    bcc _98e5
_992a:
    sec
    rts

_992c:
    jsr _9969
    bvs _9965
_9931:
    lda #$fe
    sta $392a
_9936:
    inc $392a
    inc $392a
    ldy $392a
    lda _8ab2,y
    sta $10
    lda _8ab3,y
    sta $11
    beq _9962
    ldx #$00
    lda ($10,x)
    beq _9936
    lda $392a
    lsr
    tax
    jsr _99a1
    bcs _9936
    lda $10
    ldy $11
    clv
    clc
    rts
_9962:
    clv
    sec
    rts
_9965:
    bit $3929
    rts

_9969:
    ldx #$3e
    tay
    beq _997d
_996e:
    inx
    cpx #$5d
    bcs _999d
    lda $395b,x
    cmp #$3b
    bne _996e
    dey
    bne _996e
_997d:
    inx
    stx $395a
    ldy #$00
_9983:
    cpx #$5d
    bcs _9996
    lda $395b,x
    inx
    cmp #$20
    beq _9983
    sta $3ac8,y
    iny
    jmp _9983
_9996:
    lda #$3b
    sta $3ac8,y
    clv
    rts
_999d:
    bit $3929
    rts

_99a1:
    ldy #$16
    lda ($10),y
    pha
    lda #$3b
    sta ($10),y
    stx $2d
    lda #$c8
    ldy #$3a
    ldx #$bb
    jsr $3300
    pla
    ldy #$16
    sta ($10),y
    rts

_99bb:
    ldx #$a3        ; ?<
    jsr $3300
    lda $379e
    beq _99c9
    cmp #$ff
    bne _99de
_99c9:
    lda $379b
    and #$02
    sta $392d
    lda $379b
    and #$01
    sta $392c
    jsr _8823
    clc
    rts
_99de:
    sec
    rts

_99e0:
    lda $374b
    bne _99ee
    lda $374c
    cmp #$03
    bcs _99ee
    sec
    rts
_99ee:
    dec $374c
    lda $374c
    cmp #$ff
    bne _99fd
    lda #$00
    sta $374b
_99fd:
    dec $374c
    lda $374c
    cmp #$ff
    bne _9a0c
    lda #$00
    sta $374b
_9a0c:
    clc
    rts

_9a0e:
    lda $379e
    cmp #$01
    beq _99de
    lda $379a
    and #$01
    sta $392c
    lda $379a
    and #$02
    sta $392d
    lda $379b
    and #$0c
    sta $3b0b
    lda $3797
    and #$02
    beq _9a3b
    eor $392d
    beq _9a3b
    sec
    rts
_9a3b:
    clc
    rts

_9a3d:
    ldy #$16
    lda ($14),y
    and #$80
    and $3959
    beq _9a4c
    jsr _9a4e
    rts
_9a4c:
    clc
    rts
_9a4e:
    lda #$03
    sta $3b01
    ldx #$16
    ldy #$16
    jsr _9af2
    bcs _9aa2
    jsr _9b14
    bcs _9aa9
    lda $3aff
    cmp $3b00
    bne _9aa9
    lda $3aff
    beq _9aa9
    dec $3b01
    jsr _9af2
    bcs _9aa4
    jsr _9b14
    bcs _9aa9
    lda $3aff
    cmp $3b00
    bne _9aa9
    lda $3aff
    beq _9aab
    dec $3b01
    jsr _9af2
    bcs _9aa4
    jsr _9b14
    bcs _9aa9
    lda $3aff
    cmp $3b00
    bne _9aa9
    lda $3aff
    beq _9aab
_9aa2:
    clc
    rts
_9aa4:
    jsr _9b14
    bcs _9aa2
_9aa9:
    sec
    rts
_9aab:
    sty $3b02
    jsr _9b14
    bcs _9aa2
    jsr _9b14
    bcs _9aa2
    jsr _9b14
    bcs _9aa2
    ldy $3b02
    jsr _9af2
    bcs _9aa9
    jsr _9b14
    lda $3aff
    cmp $3b00
    bne _9aa9
    lda $3aff
    beq _9aa9
    dec $3b01
    beq _9aa2
    jsr _9af2
    bcs _9aa9
    jsr _9b14
    lda $3aff
    cmp $3b00
    bne _9aa9
    lda $3aff
    beq _9aa9
    jmp _9aa2

_9af2:
    lda #$00
    sta $3aff
_9af7:
    dex
    bpl _9afc
    sec
    rts
_9afc:
    lda $3780,x
    cmp #$58
    beq _9b12
    cmp #$78
    beq _9b12
    cmp #$30
    bcc _9af7
    cmp #$3a
    bcs _9af7
    sta $3aff
_9b12:
    clc
    rts

_9b14:
    lda #$00
    sta $3b00
_9b19:
    dey
    bpl _9b1e
    sec
    rts
_9b1e:
    lda $376a,y
    cmp #$58
    beq _9b34
    cmp #$78
    beq _9b34
    cmp #$30
    bcc _9b19
    cmp #$3a
    bcs _9b19
    sta $3b00
_9b34:
    clc
    rts

_9b36:
    lda $37a9
    bne _9b3d
    clc
    rts
_9b3d:
    sec
    rts

_9b3f:
    lda $37b0
    cmp #$01
    beq _9b4a
    cmp #$02
    bne _9b5a
_9b4a:
    lda $37b1
    cmp #$01
    bne _9b5a
    lda $37b2
    cmp #$01
    bne _9b5a
    clc
    rts
_9b5a:
    sec
    rts         ; >?

_9b5c:
    lda #$5b
    ldy #$39
_9b60:                      ; RAM entry point 1
    sta $12
    sty $13
    ldx #$00
_9b66:
    ldy _9b8f,x
    cpy #$ff
    beq _9b8b
_9b6d:
    lda ($12),y
    cmp _9b91,x
    bcc _9b88
    cmp _9b92,x
    beq _9b7b
    bcs _9b88
_9b7b:
    iny
    tya
    cmp _9b90,x     ; 
    bne _9b6d
    inx
    inx
    inx
    inx
    bne _9b66
_9b88:
    tya
    sec
    rts
_9b8b:
    lda #$00
    clc
    rts

_9b8f:
.byte $00
_9b90:
.byte $01
_9b91:
.byte $66
_9b92:
.byte         $66,$05,$06,$00,$1f,$06,$07,$00,$0c,$08,$09,$00,$17,$09
.byte $0a,$00,$3b,$0a,$0b,$39,$3f,$0b,$0c,$3f,$5d,$0c,$0d,$00,$05,$0d
.byte $23,$20,$7e,$23,$39,$20,$7e,$3f,$5d,$20,$7e,$5e,$5f,$20,$7e,$ff
; The block of data terminates with $ff

_9bc0:
    ldx #$15        ; ?<
_9bc2:
    lda $fd07,x     ; Read from $fd07-$fd1c
    sta $397e,x
    lda $3780,x
    cmp #$20
    bcc _9bd3
    cmp #$7f
    bcc _9bd5
_9bd3:
    lda #$20
_9bd5:
    sta $3968,x
    dex
    bpl _9bc2
    lda $fd02
    sta $3963
    lda $fd01
    sta $3964
    lda $fd03
    sta $3960
    lda $fd04
    sta $3961
    lda $fd05
    sta $3962
    ldy #$1a
    lda ($14),y
    sta $3967
    lda $fdeb
    sta $395e
    lda $fdec
    sta $395f
    jsr _9b5c
    bcc _9c14
    brk
    sty $00
_9c14:
    rts             ; >?

_9c15:       ; RAM entry point 10
    lda $3b23
    bne _9c64
    inc $37b7
    lda $37c3
    sta $37c4
    lda #$00
    sta $37c3
    lda #$01
    sta $3b24
_9c2d:
    lda $39cb
    cmp $3b24
    bne _9c38
_9c35:
    jmp _9d2f
_9c38:
    cmp #$4c
    bcc _9c35
    jsr _9d3b
    lda $39cb
    inx
    stx $3b24
    sec
    sbc $3b24
    sta $3b24
    cpx #$4b
    bne _9c57
    inc $3b24
    jmp _9c58
_9c57:
    inx
_9c58:
    stx $39cb
    stx $3b37
    lda #$10
    sta $3b23
    rts
_9c64:
    cmp #$10
    bne _9cb2
    inc $37b8
    ldy $3b37
    jsr _9c89
    lda $3b24
    cmp #$4f
    bcs _9c7e
    lda #$20
    sta $3b23
    rts
_9c7e:
    sta $39cb
    lda #$01
    sta $3b24
    jmp _9c2d
_9c89:
    lda #$00
    sta $37c0
    ldx #$01
_9c90:
    lda $39cb,y
    cmp #$20
    bne _9c9e
    lda $37c0
    beq _9cac
    lda #$20
_9c9e:
    sta $39cb,x
    sta $37c0
    inx
_9ca5:
    iny
    cpx $3b24
    bcc _9c90
    rts
_9cac:
    dec $3b24
    jmp _9ca5
_9cb2:
    cmp #$20
    bne _9d1d
    inc $37b9
    ldx $3b24
    lda $39cb,x
    cmp #$02
    bcs _9cd7
    lda $3b24
    sta $39cb
    lda #$00
    sta $37c3
    sta $37c4
    lda #$30
    sta $3b23
    rts
_9cd7:
    ldy $37c4
    bne _9cf6
    clc
    adc $3b24
    sta $39cb
    lda #$20
    sta $39cb,x
    ldy $37c3
    sty $37c4
    ldy #$00
    sty $37c3
    jmp _9c2d
_9cf6:
    ldy $37c3
    sty $37c4
    ldy #$00
    sty $37c3
    tay
    dey
    sty $3420
    tya
    clc
    adc $3b24
    sta $39cb
_9d0e:
    lda $39cc,x
    sta $39cb,x
    inx
    dec $3420
    bne _9d0e
    jmp _9c2d
_9d1d:
    cmp #$30
    bne _9d38
    inc $37ba
    lda #$01
    sta $39cb
    sta $3b24
    jmp _9c2d

_9d2f:
    lda #$00
    sta $3b24
    sta $3b23
    rts
_9d38:
    brk
_9d39:
.byte $cc,$00

_9d3b:
    ldx #$4a
    lda $39cc,x
    cmp #$20
    beq _9d58
    dex
_9d45:
    lda $39cc,x
    ldy #$0d
_9d4a:
    cmp _9d59,y
    beq _9d58
    dey
    bpl _9d4a
    dex
    bne _9d45
    ldx #$49
    rts
_9d58:
    rts
_9d59:
.byte " !)-]}:;?/.,>"
_9d66:
.byte $a0,$a8,$b0,$b8
_9d6a:
.byte $c0,$c8,$d0,$d8,$e0,$e8,$f0,$f8,$ff,$90,$98
_9d75:
.byte $a0,$b0,$b8,$c0,$c8,$e8

_9d7b:       ; RAM entry point 11
    lda $37c1
    beq _9d83
    jmp _a216
_9d83:
    ldx #$00
_9d85:
    lda $3b1d
    sta $3b1e
_9d8b:
    ldy $3b1f
_9d8e:
    lda _9d66,y
    sta $3b1d
    lda $3b2f
    beq _9d9f
    lda $0c02,x
    jmp _9da2
_9d9f:
    lda $0b02,x
_9da2:
    cmp $3b1d
    beq _9e05
    iny
    cpy #$0f
    bne _9d8e
    cmp #$90
    bcc _9dff
    cmp #$a0
    bcc _9dbc
    cmp $3b1e
    bcc _9dff
_9db9:
    sta $3b1d
_9dbc:
    cmp #$d0
    beq _9dc8
    cmp #$d8
    beq _9dc8
    cmp #$e0
    bne _9dcb
_9dc8:
    sta $3b27
_9dcb:
    jsr _a1c7
    sta $3b2c
    jsr _a1c7
    sta $3b2d
    lda $3b2c
    bne _9def
_9ddc:
    lda $3b2d
    beq _9de9
_9de1:
    jsr _a1c7
    dec $3b2d
    bne _9de1
_9de9:
    jsr _a1fb
    jmp _9d85
_9def:
    jsr _a1c7
    dec $3b2d
    bne _9def
    dec $3b2c
    bne _9def
    jmp _9ddc
_9dff:
    lda #$ff
    sta $3b1d
    rts
_9e05:
    lda $3b27
    beq _9e11
    cpy #$0d
    bcs _9e19
    jmp _9dff
_9e11:
    cpy #$0d
    bcs _9dff
    iny
    sty $3b1f
_9e19:
    lda $3b1d
    cmp #$a8
    bne _9e23
    jmp _9eaa
_9e23:
    cmp #$d0
    bne _9e2d
    sta $3b27
    jmp _a028
_9e2d:
    cmp #$90
    bne _9e34
    jmp _9f55
_9e34:
    cmp #$d8
    bne _9e3e
    sta $3b27
    jmp _9f37
_9e3e:
    cmp #$e0
    bne _9e48
    sta $3b27
    jmp _9f37
_9e48:
    cmp #$98
    bne _9e4f
    jmp _a0f4
_9e4f:
    cmp #$f0
    bne _9e56
    jmp _a084
_9e56:
    cmp #$f8
    bne _9e6c
    jsr _a1fb
    jsr _a1fb
    jsr _a1fb
    stx $3b20
    lda #$00
    sta $3430
    rts
_9e6c:
    ldy #$00
_9e6e:
    lda _9d75,y
    cmp $3b1d
    bne _9e79
    jmp _9db9
_9e79:
    iny
    cpy #$06
    bcc _9e6e
    brk
_9e7f:
.byte $c4,$00

_9e81:
    cmp #$20
    bcc _9ea7
    cmp #$60
    bne _9e8b
    lda #$22
_9e8b:
    cmp #$23
    bne _9e91
    lda #$60
_9e91:
    cmp #$ca
    bne _9e97
    lda #$23
_9e97:
    cmp #$cb
    bne _9e9d
    lda #$63
_9e9d:
    cmp #$7f
    bne _9ea3
    lda #$40
_9ea3:
    cmp #$7f
    bcc _9ea9
_9ea7:
    lda #$20
_9ea9:
    rts

_9eaa:
    jsr _a1c7
    beq _9eb2
    jmp _9dff
_9eb2:
    jsr _a1c7
    cmp #$0e
    beq _9ebf
    sta $3431
    jmp _9f47
_9ebf:
    jsr _a1c7
    sta $37be
    jsr _a1c7
    sta $3420
    lda $37be
    jsr _a18c
    sta $3963
    jsr _a1fb
    jsr _a1c7
    sta $37be
    jsr _a1c7
    sta $3420
    lda $37be
    jsr _a18c
    sta $3964
    jsr _a1fb
    jsr _a1c7
    sta $37be
    jsr _a1c7
    sta $3420
    lda $37be
    jsr _a18c
    sta $3960
    jsr _a1fb
    jsr _a1c7
    sta $37be
    jsr _a1c7
    sta $3420
    lda $37be
    jsr _a18c
    sta $3961
    jsr _a1fb
    jsr _a1c7
    sta $37be
    jsr _a1c7
    sta $3420
    lda $37be
    jsr _a18c
    sta $3962
    jmp _9f4f
_9f37:
    jsr _a1c7
    beq _9f3f
    jmp _9dff
_9f3f:
    jsr _a1c7
    beq _9f4f
    sta $3431
_9f47:
    jsr _a1c7
    dec $3431
    bne _9f47
_9f4f:
    jsr _a1fb
    jmp _9d85

_9f55:
    lda #$d0
    cmp $3b27
    bne _9f69
    lda #$00
    sta $3b27
    sta $3430
    jsr _a1c7
    beq _9f6c
_9f69:
    jmp _9dff
_9f6c:
    jsr _a1c7
    sta $3431
    cmp #$21
    bcc _9f81
_9f76:
    jsr _a1c7
    dec $3431
    bne _9f76
    jmp _9ff1
_9f81:
    ldy $3b22
    iny
    stx $37be
    ldx #$00
_9f8a:
    lda _a01f,x     ; Characters from below
    sta $39cb,y
    iny
    inx
    cpx #$09
    bne _9f8a
    ldx $37be
    lda $3431
    beq _9fad
_9f9e:
    jsr _a1c7
    jsr _9e81
    sta $39cb,y
    iny
    dec $3431
    bne _9f9e
_9fad:
    lda $3b21
    ora #$04
    sta $3b21
    stx $37be
    sec
    ldx $3b22
    tya
    sbc $3b22
    sta $39cb,x
    sty $3b22
    clc
    sbc #$09
    beq _9fee
    sta $3431
    txa
    sec
    adc #$09
    tay
    ldx #$00
_9fd5:
    lda $39cb,y
    cmp #$30
    bcc _9fe8
    cmp #$3a
    bcs _9ff7
_9fe0:
    cpx #$16
    beq _9fe8
    sta $397e,x
    inx
_9fe8:
    iny
    dec $3431
    bne _9fd5
_9fee:
    ldx $37be
_9ff1:
    jsr _a1fb
    jmp _9d8b
_9ff7:
    cmp #$58
    beq _9fff
    cmp #$78
    bne _9fe8
_9fff:
    lda $3430
    bne _9fe8
    lda $3431
    cmp #$03
    bcc _9fe8
    lda $39cc,y
    cmp #$30
    bcc _9fe8
    cmp #$3a
    bcs _9fe8
    lda $39cb,y
    sta $3430
    jmp _9fe0
_a01f:
.byte "NUMBER:  "

_a028:
    jsr _a1c7
    beq _a030
_a02d:
    jmp _9dff
_a030:
    jsr _a1c7
    sta $3431
_a036:
    lda $3b21
    and #$40
    bne _a02d
    lda $3431
    cmp #$41
    bcc _a047
    jmp _9f47
_a047:
    ldy $3b22
    iny
    stx $37be
    ldx #$00
_a050:
    lda _a07b,x     ; Characters from below
    sta $39cb,y
    iny
    inx
    cpx #$09
    bne _a050
    ldx $37be
    lda $3431
    beq _a073
_a064:
    jsr _a1c7
    jsr _9e81
    sta $39cb,y
    iny
    dec $3431
    bne _a064
_a073:
    lda $3b21
    ora #$50
    jmp _a0ce
_a07b:
.byte "FROM:    "

_a084:
    jsr _a1c7
    beq _a08c
_a089:
    jmp _9dff
_a08c:
    jsr _a1c7
    cmp #$41
    bcs _a089
    sta $3431
    lda $3b21
    and #$80
    bne _a089
    ldy $3b22
    iny
    stx $37be
    ldx #$00
_a0a6:
    lda _a0eb,x
    sta $39cb,y
    iny
    inx
    cpx #$09
    bne _a0a6
    ldx $37be
    lda $3431
    beq _a0c9
_a0ba:
    jsr _a1c7
    jsr _9e81
    sta $39cb,y
    iny
    dec $3431
    bne _a0ba
_a0c9:
    lda $3b21
    ora #$a0
_a0ce:
    sta $3b21
    jsr _a1fb
    stx $3b20
    sec
    ldx $3b22
    tya
    sbc $3b22
    sta $39cb,x
    sty $3b22
    ldx $3b20
    jmp _9d85
_a0eb:
.byte "SUBJECT: "

_a0f4:
    lda $3b27
    cmp #$d8
    beq _a102
    cmp #$e0
    beq _a102
_a0ff:
    jmp _9dff
_a102:
    lda #$00
    sta $3b27
    jsr _a1c7
    bne _a0ff
    jsr _a1c7
    bne _a114
    jmp _a169
_a114:
    sta $3430
    lda $3b28
    beq _a13f
    cmp #$01
    bne _a16c
    inc $3b28
    jsr _a17f
    ldy #$3f
    stx $37be
    ldx #$00
_a12d:
    lda _a177,x
    sta $395b,y
    iny
    inx
    cpx #$08
    bne _a12d
    ldx $37be
    jmp _a16c
_a13f:
    inc $3b28
    ldy #$3f
_a144:
    jsr _a1c7
    jsr _9e81
    cmp #$2e
    beq _a15a
    cmp #$20
    beq _a15a
    cmp #$2d
    beq _a15a
    sta $395b,y
    iny
_a15a:
    dec $3430
    beq _a169
    cpy #$16
    bne _a144
    jsr _a17f
    jmp _a16c
_a169:
    jmp _9ff1
_a16c:
    jsr _a1fb
    dec $3430
    beq _a169
    jmp _a16c
_a177:
.byte "multiple"

_a17f:
    ldy #$3f
    lda #$20
_a183:
    sta $395b,y
    iny
    cpy #$5d
    bne _a183
    rts

_a18c:
    and #$0f
    asl
    asl
    asl
    asl
    pha
    lda $3420
    and #$0f
    sta $3420
    pla
    sed
    clc
    adc $3420
    ldy #$00
    cmp #$16
    bcc _a1af
_a1a7:
    sec
    sbc #$16
    iny
    cmp #$16
    bcs _a1a7
_a1af:
    cmp #$10
    bcc _a1b9
    and #$0f
    clc
    cld
    adc #$0a
_a1b9:
    cld
    sta $3420
    tya
    asl
    asl
    asl
    asl
    clc
    adc $3420
    rts

_a1c7:
    jsr _a235
    bcs _a1e5
    lda $3b2f
    bne _a1e0
    inx
    beq _a1d8
    lda $0b02,x
    rts
_a1d8:
    lda #$ff
    sta $3b2f
    jmp _a1e1
_a1e0:
    inx
_a1e1:
    lda $0c02,x
    rts
_a1e5:
    lda #$ff
_a1e7:
    sta $3b2b
    sty $3b36
    lda #$ff
    sta $37c1
    pla
    sta $3b29
    pla
    sta $3b2a
    rts

_a1fb:
    jsr _a235
    bcs _a211
_a200:
    lda $3b2f
    bne _a20f
    inx
    beq _a209
    rts
_a209:
    lda #$ff
    sta $3b2f
    rts
_a20f:
    inx
    rts
_a211:
    lda #$7f
    jmp _a1e7

_a216:
    lda #$00
    sta $3b2f
    sta $37c1
    tax
    lda $3b2a
    pha
    lda $3b29
    pha
    ldy $3b36
    lda $3b2b
    cmp #$7f
    beq _a234
    lda $0b02,x
_a234:
    rts

_a235:
    dec $374c
    beq _a23c
_a23a:
    clc
    rts
_a23c:
    lda $374b
    beq _a249
    lda #$00
    sta $374b
    jmp _a23a
_a249:
    sec
    rts

_a24b:       ; RAM entry point 12
    lda #$0a
    sta $3431
    ldx #$08
    ldy #$00
    lda #$a8
    sta $0b02,y
    iny
    lda #$00
    sta $0b02,y
    iny
    lda #$0e
    sta $0b02,y
    iny
    lda $395b,x
    jsr _a3da
    inx
    lda #$3a
    sta $0b02,y
    iny
    lda $395b,x
    jsr _a3da
    lda #$20
    sta $0b02,y
    iny
    ldx #$05
    lda $395b,x
    jsr _a3da
    inx
    lda #$2f
    sta $0b02,y
    iny
    lda $395b,x
    jsr _a3da
    inx
    lda #$2f
    sta $0b02,y
    iny
    lda $395b,x
    jsr _a3da
    lda #$d0
    sta $0b02,y
    iny
    lda #$00
    sta $0b02,y
    iny
    tax
    lda #$0a
    sta $0b02,y
    iny
_a2b4:
    lda _a3b9,x         ; Read the text from below
    sta $0b02,y
    iny
    inx
    cpx #$0a
    bcc _a2b4
    lda #$90
    sta $0b02,y
    iny
    lda #$00
    sta $0b02,y
    iny
    sta $3430
    tax
    sty $3b22
    iny
    lda #$16
    sta $3431
_a2d9:
    lda _a3c3,x
    sta $0b02,y
    inc $3430
    iny
    inx
    cpx #$08
    bcc _a2d9
    ldx #$00
_a2ea:
    lda $fd07,x
    cmp #$30
    bne _a2fa
    lda $3430
    cmp #$08        ; backspace
    beq _a319
    lda #$30        ; "0"
_a2fa:
    cmp #$20        ; " "
    beq _a319
    cmp #$58        ; "X"
    beq _a312
    cmp #$78        ; "x"
    beq _a312
    cmp #$3b        ; ";"
    beq _a31f
    cmp #$30        ; "0"
    bcc _a319
    cmp #$3a        ; ":"
    bcs _a319
_a312:
    sta $0b02,y
    iny
    inc $3430
_a319:
    inx
    dec $3431
    bne _a2ea
_a31f:
    ldx $3b22
    lda $3430
    sta $0b02,x
    lda #$d8
    sta $0b02,y
    iny
    lda #$00
    sta $0b02,y
    iny
    sta $0b02,y
    iny
    lda #$98
    sta $0b02,y
    iny
    lda #$00
    sta $0b02,y
    sta $3430
    iny
    tya
    sta $3b22
    iny
    ldx #$0b
    lda $395b,x
    tax
_a352:
    lda $395b,x
    cmp #$3b
    beq _a370
    cmp #$7d
    beq _a370
    sta $0b02,y
    inc $3430
    iny
    inx
    cpx #$5d
    beq _a370
    lda $3430
    cmp #$16
    bne _a352
_a370:
    tya
    tax
    lda $3b22
    tay
    lda $3430
    sta $0b02,y
    txa
    tay
    lda #$f0
    sta $0b02,y
    iny
    lda #$00
    sta $0b02,y
    iny
    tax
    lda #$0f
    sta $0b02,y
    iny
_a391:
    lda _a3cb,x
    sta $0b02,y
    iny
    inx
    cpx #$0f
    bcc _a391
    lda #$f8
    sta $0b02,y
    iny
    lda $37bc
    sta $0b02,y
    iny
    lda $37bd
    sta $0b02,y
    iny
    sty $374c
    iny
    sty $374e
    rts

_a3b9:
.byte "M2105 User"
_a3c3:
.byte "TML:944-"
_a3cb:
.byte "(M2105 Message)"

_a3da:
    pha
    and #$f0
    lsr
    lsr
    lsr
    lsr
    sta $3420
    cmp #$00
    beq _a3fb
    txa
    pha
    ldx $3420
    sed
    lda #$00
_a3f0:
    clc
    adc #$16
_a3f3:
    dex
    bne _a3f0
    sta $3420
    pla
    tax
_a3fb:
    pla
    and #$0f
    cmp #$0a
    bcc _a40a
    cld
    sec
    sbc #$0a
    sed
    clc
    adc #$10
_a40a:
    clc
    adc $3420
    sta $3420
    and #$f0
    lsr
    lsr
    lsr
    lsr
    cld
    clc
    adc #$30
    sta $0b02,y
    iny
    lda $3420
    and #$0f
    clc
    adc #$30
    sta $0b02,y
    iny
    rts

_a42c:       ; RAM entry point 14
    ldx #$01
    ldy $3b20
    sty $3b31
    sty $37bf
    lda $3b2f
    sta $3b2e
    sta $3b30
    jsr _a614
    lda #$00
    jmp _a45c

_a448:       ; RAM entry point 15
    ldx #$01
    stx $37bf
    lda #$00
    tay
    sta $3b2e
    sta $3b2f
    sta $3b30
    sta $3b31
_a45c:
    sta $37b5
    sta $3b35
    sta $37be
_a465:
    lda $3b2f
    beq _a470
    lda $0c02,y
    jmp _a473
_a470:
    lda $0b02,y
_a473:
    cmp #$ff
    bne _a47a
    jmp _a4fc
_a47a:
    cmp #$0d
    beq _a482
    cmp #$0a
    bne _a485
_a482:
    jmp _a539
_a485:
    jsr _9e81
    cpx #$01
    beq _a4a5
    pha
    lda $3b2f
    bne _a4df
    lda $37be
    sty $3420
    ldy $37bf
    sta $0b02,y
_a49e:
    jsr _a614
    ldy $3420
    pla
_a4a5:
    sta $37be
    inx
    cpx #$ff
    bne _a4b1
    stx $37c2
    rts
_a4b1:
    jsr _a61f
    bcc _a465
    cpx #$01
    bne _a4bb
    rts
_a4bb:
    inc $37b6
    inc $3b35
    lda $3b35
    sta $37b4
    ldy $3b31
    dex
    stx $37c2
    lda $3b30
    beq _a4d9
    lda #$ff
    sta $0c02,y
    rts
_a4d9:
    lda #$ff
    sta $0b02,y
    rts
_a4df:
    sty $3420
    ldy $37bf
    lda $3b2e
    beq _a4f3
    lda $37be
    sta $0c02,y
    jmp _a49e
_a4f3:
    lda $37be
    sta $0b02,y
    jmp _a49e

_a4fc:
    cpx #$01
    beq _a52d
    ldy $37bf
    lda $3b2e
    bne _a511
    lda $37be
    sta $0b02,y
    jmp _a517
_a511:
    lda $37be
    sta $0c02,y
_a517:
    ldy $3b31
    lda $3b30
    bne _a526
    txa
    sta $0b02,y
    jmp _a52a
_a526:
    txa
    sta $0c02,y
_a52a:
    inc $3b35
_a52d:
    lda #$ff
    sta $3b25
    lda $3b35
    sta $37b4
    rts

_a539:
    cpx #$01
    bne _a540
    jmp _a5f2
_a540:
    lda $37be
    cmp #$20
    bne _a5a6
    cpx #$02
    beq _a54e
    jmp _a577
_a54e:
    inc $37b5
    tya
    pha
    ldy $3b31
    dex
    lda $3b30
    beq _a563
    txa
    sta $0c02,y
    jmp _a567
_a563:
    txa
    sta $0b02,y
_a567:
    jsr _a62d
    jsr _a614
    pla
    tay
_a56f:
    inc $3b35
    ldx #$01
    jmp _a4b1
_a577:
    lda #$00
    sta $37be
    dex
    tya
    pha
    ldy $3b31
    lda $3b30
    bne _a59f
    txa
    sta $0b02,y
_a58b:
    ldy $37bf
    sty $3b31
    ldy $3b2e
    sty $3b30
    jsr _a614
    pla
    tay
    jmp _a56f
_a59f:
    txa
    sta $0c02,y
    jmp _a58b
_a5a6:
    tya
    pha
    ldy $3b31
    lda $3b30
    bne _a5d9
    txa
    sta $0b02,y
    ldy $37bf
    lda $3b2e
    bne _a5e9
    lda $37be
    sta $0b02,y
_a5c2:
    jsr _a614
    lda $3b2e
    sta $3b30
    ldy $37bf
    sty $3b31
    jsr _a614
    pla
    tay
    jmp _a56f
_a5d9:
    txa
    sta $0c02,y
    ldy $37bf
    lda $37be
    sta $0c02,y
    jmp _a5c2
_a5e9:
    lda $37be
    sta $0c02,y
    jmp _a5c2
_a5f2:
    sty $3420
    ldy $3b31
    lda $3b30
    bne _a60d
    txa
    sta $0b02,y
_a601:
    jsr _a62d
    jsr _a614
    ldy $3420
    jmp _a56f
_a60d:
    txa
    sta $0c02,y
    jmp _a601

_a614:
    inc $37bf
    bne _a637
    lda #$ff
    sta $3b2e
    rts

_a61f:
    jsr _a235
    bcs _a637
    iny
    bne _a637
    lda #$ff
    sta $3b2f
    rts
_a62d:
    inc $3b31
    bne _a637
    lda #$ff
    sta $3b30
_a637:
    rts

_a638:       ; RAM entry point 13
    lda $3b21
    and #$10
    beq _a64f
    lda $39cb
    sta $3430
    lda #$01
    sta $39cb
    lda #$ef
    jmp _a6b4
_a64f:
    lda $3b21
    and #$40
    beq _a661
    lda $3430
    sta $39cb
    lda #$bf
    jmp _a6b4
_a661:
    lda $3b21
    and #$04
    beq _a676
    jsr _a6cc
    lda $39cb
    sta $3431
    lda #$fb
    jmp _a6b4
_a676:
    lda $3b21
    and #$20
    beq _a691
    clc
    lda $3430
    adc $3431
    sta $3430
    lda #$01
    sta $39cb
    lda #$df
    jmp _a6b4
_a691:
    lda $3b21
    and #$80
    beq _a6a0
    jsr _a6cc
    lda #$7f
    jmp _a6b4
_a6a0:
    lda $3b21
    and #$08
    beq _a6bb
    ldy #$00
    tya
    jsr _a7d2
    lda #$01
    sta $39cb
    lda #$f7
_a6b4:
    and $3b21
    sta $3b21
    rts
_a6bb:
    lda #$00
    sta $3b21
    ldx #$a1
    jsr $3300
    ldx $3b20
    stx $3ae7
    rts

_a6cc:
    ldy #$00
    ldx $3430
    lda $39cb,x
    sta $3431
_a6d7:
    lda $39cb,x
    sta $39cb,y
    iny
    inx
    dec $3431
    bne _a6d7
    rts

_a6e5:       ; RAM entry point 16
    lda $37d2
    cmp #$0d
    bcs _a723
    ldx #$00
    jsr _a729
    bcc _a71a
    ldx #$ff
    jsr _a729
    bcs _a723
    lda $342d
    cmp #$06
    beq _a71a
    stx $379e
    stx $37d1
    lda #$54
    sta $379d
    lda #$13
    sta $379c
    lda #$02
    sta $379b
    sta $379a
    rts
_a71a:
    ldx #$00
    stx $379e
    stx $37d1
    rts
_a723:
    lda #$01
    sta $379e
    rts
_a729:
    lda #$00
    tay
_a72c:
    cpx #$00
    bne _a736
    lda _a754,y
    jmp _a739
_a736:
    lda _a759,y
_a739:
    cmp $37c5,y
    bne _a752
    iny
    cpy $37d2
    bcc _a72c
    cpx #$00
    bne _a74e
    cpy #$05
    bne _a752
_a74c:
    clc
    rts
_a74e:
    cpy #$0c
    beq _a74c
_a752:
    sec
    rts
_a754: .byte "M2105"
_a759: .byte "~CTXFR      "

_a765:       ; RAM entry point 17
    lda #$00
    tax
_a768:
    sta $395b,x
    inx
    cpx #$66
    bne _a768
    stx $395b
    lda #$39
    sta $3965
    lda #$3f
    sta $3966
    sta $3430
    lda #$54
_a782:          ; a783,4 are referred to below
    sta $39b9
    ldx #$0d
    lda #$20
    sta $395c
_a78c:
    sta $395b,x
    inx
    cpx #$39
    bne _a78c
    ldx #$3f
_a796:
    sta $395b,x
    inx
    cpx #$5d
    bne _a796
    ldx #$39
    lda #$40
_a7a2:
    sta $395b,x
    inx
    cpx #$3f
    bne _a7a2
    lda #$00
    sta $3ae7
    tay
_a7b0:
    sta $37b3,y
    iny
    cpy #$0f
    beq _a7b0
    bcc _a7b0
    tay
_a7bb:
    sta $3b1d,y
    iny
    cpy #$19
    beq _a7bb
    bcc _a7bb
    lda #$09
    sta $3b21
    lda #$6e
    sta $37bd
    lda #$00
    tay
_a7d2:
    sta $39cb,y
    iny
    cpy #$fd
    bcc _a7d2
    rts

_a7db:       ; RAM entry point 18
    lda $35ed
    bne _a7e5
    ldx #$9c
    jmp $3300
_a7e5:
    lda $35ee
    and #$df
    cmp #$41        ; "A"
    bcc _a804
    cmp #$5a        ; "Z"
    bcs _a804
    asl
    tax
    lda #$a8
    pha
    lda #$03
    pha
    lda [_a782 + 2],x
    pha
    lda [_a782 + 1],x
    pha
    php
    rti
_a804:
    rts


_a805:
.byte                     $04,$a8,$04,$a8,$04,$a8,$04,$a8,$04,$a8,$04
.byte $a8,$04,$a8,$04,$a8,$04,$a8,$04,$a8,$04,$a8,$91,$a8,$04,$a8,$04
.byte $a8,$04,$a8,$04,$a8,$04,$a8,$04,$a8,$04,$a8,$04,$a8,$04,$a8,$04
.byte $a8,$04,$a8,$04,$a8,$16,$a9

_a837:          ; ?<
    pha
    lsr
    lsr
    lsr
    lsr
    jsr _a840
    pla
_a840:              ; Write a hexadecimal digit
    and #$0f
    cmp #$0a        ; Set carry if >= 10
    sed
    adc #$30
    cld
    jmp OSWRCH

_a84b:
    cmp #$20
    bcc _a853
    cmp #$7f
    bcc _a855
_a853:
    lda #$2e       ; "."
_a855:
    jmp OSWRCH

_a858:
    cmp #$30        ; "0"
    bcc _a871
    cmp #$3a        ; "9"
    bcc _a86d
    and #$df
    cmp #$41        ; "A"
    bcc _a871
    cmp #$47        ; "F"
    bcs _a871
    sec
    sbc #$07
_a86d:
    and #$0f
    clc
    rts
_a871:
    sec
    rts

_a873:
    asl             ; ?<
    asl
    asl
    asl
    asl
    rol $16
    rol $17
    asl
    rol $16
    rol $17
    asl
    rol $16
    rol $17
    asl
    rol $16
    rol $17
    rts

_a88c:
    inx
    lda $35ee,x
    rts

_a891:
    ldx #$00
    stx $16
    stx $17
_a897:
    jsr _a88c
    jsr _a858
    bcs _a8a5
    jsr _a873
    jmp _a897
_a8a5:
    lda #$0c       ; Clear text window
    jsr OSWRCH
    ldx #$00
_a8ac:
    stx $3420
    jsr _a8bb
    ldx $3420
    inx
    cpx #$11
    bcc _a8ac
    rts

_a8bb:
    ldx #$00
    lda $17
    jsr _a837
    lda $16
    jsr _a837
    jsr _a91f
    jsr _a92b
    jsr _a92b
    jsr _a8f2
    jsr _a8f2
    jsr _a8f2
    jsr _a8f2
    jsr _a92b
    jsr _a92b
    ldx #$00
_a8e4:
    lda $3aef,x
    jsr _a84b
    inx
    cpx #$10
    bcc _a8e4
    jmp OSNEWL
_a8f2:
    jsr _a904
    jsr _a904
    jsr _a904
    jsr _a904
    jsr _a92b
    jmp _a92b
_a904:
    ldy #$00
    lda ($16),y
    sta $3aef,x
    inx
    jsr _a837
    inc $16
    bne _a915
    inc $17
_a915:
    rts

_a916:
    lda #$ff
    sta $3b05
    rts

_a91c:
    jsr _a84b
_a91f:
    lda #$3a        ; ":"
    jmp OSWRCH
    jsr _a91c
    txa
    jsr _a837
_a92b:
    lda #$20        ; " "
    jmp OSWRCH      ; >?

_a930:       ; RAM entry point 19
    jsr _ba7a
    lda #$10
    ora $3419
    sta $3419
    lda $35ed
    beq _a95a
    ldx #$01
    stx $3444
    jsr _bb01
    jsr _b7d5
    jsr _ba0c
    jsr _ae1a
    jsr _b7dc
    jsr _b79c
    jmp _a965
_a95a:
    ldx #$00
    stx $3444
    jsr _aaef
    jsr _bd58
_a965:
    lda #$16       ; MODE
    jsr OSWRCH
    lda #$03       ; 3
    jsr OSWRCH
    lda #$00
    sta $3414
    ldx #$17
    ldy $37da
    dey
    bne _a97d
    inx
_a97d:
    stx $0798
    jsr _baa1
_a983:
    ldy #$00
    sty $0797
    jsr _a991
    jsr _a9d3
    jmp _a983
_a991:
    jsr read_key
    bcs _a9c4
    txa
    jsr _a9c5
    cmp #$90
    bcc _a9a1
    jmp _aa41
_a9a1:
    ldy $37da
    dey
    beq _a9bf
    cmp #$88
    bcc _a9bf
    cmp #$8c
    bcs _a9bf
    eor #$8f
    adc #$3d
    pha
    lda #$1b
    jsr _b2eb
    lda #$5b
    jsr _b2eb
    pla
_a9bf:
    and #$7f
    jsr _b2eb
_a9c4:
    rts
_a9c5:
    ldx $0799
    beq _a9d2
    jsr _b238
    ldx #$00
    stx $0799
_a9d2:
    rts

_a9d3:
    lda $35ed
    beq _a9e0
    jsr _b85e
    bcs _a9e0
    jmp _bb18
_a9e0:
    jsr _bd11
    bcc _aa40
    jsr _a9c5
    bit $079a
    bvc _a9f0
    jmp _ac30
_a9f0:
    ldx $07f4
    beq _a9f8
    jmp _ab49
_a9f8:
    cmp #$1b
    bne _aa02
    ldx #$ff
    stx $07f4
    rts
_aa02:
    cmp #$7f
    beq _aa40
    ldy $37da
    dey
    beq +
    jsr _aa97
*   jsr _aa82
    tay
    bmi _aa40
    bit $079a
    bpl _aa25
    cmp #$0e
    bcc _aa22
    cmp #$20
    bcc _aa25
_aa22:
    jsr _aebe
_aa25:
    bit $0777
    bpl _aa2d
    jsr _af52
_aa2d:
    cmp #$0d
    bne _aa40
    ldy #$00
    sty $07f3
    ldy $37de
    beq _aa40
    lda #$0a
    jmp _aa02
_aa40:
    rts

_aa41:
    cmp #$9a
    bcs _aa51
    sec
    sbc #$90
    tax
    lda _aa52,x        ; Look up the high address byte (HH).
    pha
    lda _aa5c,x        ; Look up the low address byte (LL).
    pha
_aa51:
    rts                ; Return via the routine at $HHLL+1.

_aa52:
.byte >[_bb18 - 1],>[_aa51 - 1],>[_aa51 - 1],>[_afd0 - 1]
.byte >[_bd5f - 1],>[_af13 - 1],>[_ae39 - 1],>[_aa51 - 1]
.byte >[_bc2d - 1],>[_aa66 - 1]
_aa5c:
.byte <[_bb18 - 1],<[_aa51 - 1],<[_aa51 - 1],<[_afd0 - 1]
.byte <[_bd5f - 1],<[_af13 - 1],<[_ae39 - 1],<[_aa51 - 1]
.byte <[_bc2d - 1],<[_aa66 - 1]

; Via table at aa52:
_aa66:
    lda #$34
    clc
    adc $3444       ; Can be 0, 1, 2
    pha
    ldx #$60
    jsr ram_osword_81   ; OSWORD &81, &34-&36

_aa72:              ; ?<
    lda #$79        ; Keyboard scan
    ldx #$a6        ; for &26 (9)
    jsr OSBYTE
    txa
    bmi _aa72       ; Loop if key pressed (x < 0 if key is pressed)
    pla             ; $34-$36
    ldx #$70
    jmp ram_osword_81   ; OSWORD &81, &34-&36

_aa82:
    ldy $0797
    bne _aa96
    cmp #$07       ; Bell?
    bcc _aa96
    cmp #$0e       ; Paged mode on?
    bcc _aa93
    cmp #$1e       ; Home?
_aa91:
    bcc _aa96
_aa93:
    jsr OSWRCH
_aa96:
    rts

_aa97:
    pha
    pha
    jsr get_cursor_pos
    pla
    cpy #$00       ; Top row?
    beq _aac6
    cpy #$17       ; Row 23
    beq _aaa7
_aaa5:
    pla
    rts
_aaa7:
    cmp #$0a       ;
    beq _aab7
    cpx #$4f       ; Column 79?
    bne _aaa5      ; then return
_aaaf:
    cmp #$0d
    beq _aaa5
    cmp #$08
    beq _aaa5
_aab7:
    jsr write_record_char      ; Write character
    lda #$0a                   ; Move cursor down
    jsr OSWRCH
    lda #$0b                   ; Move cursor up
    jsr OSWRCH
    pla
    rts
_aac6:
    cmp #$0b
    beq _aad5
    cpx #$00       ; Column 0?
    bne _aaa5      ; Exit if not
    cmp #$08       ; Cursor left?
    beq _aad5
    jmp _aaa5      ; Exit if not
_aad5:
    jsr write_record_char
    jsr record_cursor_pos
    ldx #$00
    ldy #$18                    ; A full row at y=24
    jsr define_text_window_row
    jsr set_cursor_pos
    pla
    rts

write_record_char:          ; aae7
    ldy #$ff
    sty $0797
    jmp OSWRCH

_aaef:
    lda #$34
    ldy #$33
    php
    sei
    sta $0204
    sty $0205
    plp
    jsr _ab30
    lda #$00                ; Enable serial transmitter
    jsr ram_osword_81
    lda #$02                ; Enable serial receiver
    jsr ram_osword_81
    lda #$0c                ; Enable RS423 interrupts
    ldx #$02
    jsr ram_osword_81
    lda #$0e                ; Set RS423 data word configuration
    ldx $37e9
    jsr ram_osword_81
    ldx $37e7
    lda #$07                ; Set RS423 baud receive rate
    jsr OSBYTE
    ldx $37e8
    lda #$08                ; Set RS423 baud transmit rate
    jsr OSBYTE
    lda #$08                ; Write RS423 handshake
    ldx #$05
    jsr ram_osword_81
    rts
_ab30:
    lda #$04                ; Reset serial transmitter
    jsr ram_osword_81
    lda #$05                ; Reset serial receiver
    jsr ram_osword_81
    lda #$08                ; Write RS423 handshake
    ldx #$85
    jmp ram_osword_81
_ab41:
    pha
    lda #$07                ; Bell
    jsr OSWRCH
    pla
    rts
_ab49:
    cpx #$ff
    bcc _ab62
    cmp #$5b
    beq _ab59
    ldx #$00
    stx $07f4
    jmp _aa82
_ab59:
    dec $07f4
    ldy #$00
    sty $0764
    rts
_ab62:
    cmp #$30
    bcc _ab7b
    ldy $0764
    sta $076c,y
    sta $076d,y
    cmp #$40
    bcs _ab81
    iny
    sty $0764
    cpy #$08
    bcc _ab80
_ab7b:
    ldx #$00
    stx $07f4
_ab80:
    rts
_ab81:
    ldx #$00
    stx $07f4
    dex
_ab87:
    inx
    cmp _ab99,x
    bcc _ab87
    beq _ab90
    rts
_ab90:
    lda _aba4,x         ; Load high address byte (HH)
    pha
    lda _abae,x         ; Load low address byte (LL)
    pha
    rts                 ; Return to $HHLL+1

_ab99:
.byte "mifKJHDCBA", $00
_aba4:
.byte >[_abb8 - 1],>[_abf0 - 1],>[_ac85 - 1],>[_adbe - 1],>[_ad66 - 1]
.byte >[_ac85 - 1],>[_acb9 - 1],>[_acb9 - 1],>[_acb9 - 1],>[_acb9 - 1]
_abae:
.byte <[_abb8 - 1],<[_abf0 - 1],<[_ac85 - 1],<[_adbe - 1],<[_ad66 - 1]
.byte <[_ac85 - 1],<[_acb9 - 1],<[_acb9 - 1],<[_acb9 - 1],<[_acb9 - 1]

_abb8:
     dey
    bmi _abc2
    lda $076c,y
    cmp #$30
    bne _abcc
_abc2:
    ldx #$00
    stx $076b
_abc7:
    lda #$14       ; Restore default colours
    jmp OSWRCH

_abcc:
    ldx #$ff
    stx $076b
inverted_colours:
    lda #$11       ; Colour
    jsr OSWRCH
    lda #$00       ; 0
    jsr OSWRCH
    lda #$11       ; Colour
    jsr OSWRCH
    lda #$81       ; 129
    jmp OSWRCH
_abe5:
    lda $076b
    beq _abed
    jmp _abc2
_abed:
    jmp _abcc
_abf0:
    dey
    bmi _ac03
    jsr _ad2d
    dey
    beq _ac16
    lda $0764
    beq _ac03
    cmp #$05
    beq _ac06
    rts
_ac03:
    jmp _afd0
_ac06:
    lda $079a
    bmi _ac10
    jsr _ae39
    lda #$00
_ac10:
    ora #$40
    sta $079a
    rts
_ac16:
    lda $076c
    cmp #$3f
    bne _ac2f
    iny
    jsr _ad2f
    cmp #$04
    bne _ac28
    jmp _ae7b
_ac28:
    cmp #$05
    bne _ac2f
    jmp _ae33
_ac2f:
    rts

_ac30:
    cmp #$1b
    bne _ac37
    jsr _aeea
_ac37:
    inc $07a1
    ldx $07a1
    sta $07a1,x
    cmp #$69
    bne _ac6a
    cpx #$04
    bne _ac6a
    ldx #$01
    lda $07a1,x
    cmp #$1b
    bne _ac6a
    inx
    lda $07a1,x
    cmp #$5b
    bne _ac6a
    inx
    lda $07a1,x
    cmp #$34
    beq _ac72
    cmp #$35
    bne _ac6a
    ldx #$00
    stx $07a1
_ac6a:
    cpx #$50
    bcc _ac71
    jsr _aeea
_ac71:
    rts
_ac72:
    ldx #$00
    stx $07a1
    rol $079a
    bcs _ac7f
    jmp _ae7b
_ac7f:
    lda #$80
    sta $079a
    rts
_ac85:
    jsr _ad2d
    tax
    dex
    dex
    bmi _ac96
    cpx $0798
    bcc _ac96
    ldx $0798
    dex
_ac96:
    inx
    stx $0768
    jsr _ad2f
    tax
    cpx #$51
    bcc _aca4
    ldx #$50
_aca4:
    dex
    stx $0767
; aca8
set_cursor_pos:                 ; Move text cursor to x=($0767), y=($0768)
    lda #$1f
    jsr OSWRCH
    lda $0767
    jsr OSWRCH
    lda $0768
    jmp OSWRCH

_acb9:
    inx
    inx
    stx $0766
    jsr _ad2d
_acc1:
    pha
    jsr get_cursor_pos
    lda $0766
    cmp #$0a
    bcc _acdd
    bne _acd4
    clc
    adc $37da
    and #$fe
_acd4:
    tax
    tya
    cmp [_ace7 + 2],x
    bne _ace4
_acdb:
    pla
    rts
_acdd:
    tay
    txa
    cmp [_ace7 + 2],y
    beq _acdb
_ace4:
    lda $0766
_ace7:
    jsr OSWRCH
    pla
    tay
    dey
    tya
    bne _acc1
    rts

_acf1:
.byte $00,$4f,$18,$00,$17

record_cursor_pos:
    jsr get_cursor_pos
    stx $0767
    sty $0768
    rts

_ad00:
    jsr get_cursor_pos
    cpy $0798
    bcc clear_to_line_end
define_text_window_row: ; ad08
    tya                    ; Text window bottom=top
    jsr define_text_window
    lda #$0a               ; Newline
    jsr OSWRCH
    lda #$1a               ; Reset text window
    jmp OSWRCH

clear_to_line_end:
    cpx #$50
    beq _ad23
    lda #$20
    jsr OSWRCH
    inx
    jmp clear_to_line_end
_ad23:
    rts

_ad24:
    ldx $076b
    beq +
    jsr inverted_colours
*   rts

_ad2d:
    ldy #$00
_ad2f:
    lda #$00
    sta $0764
_ad34:
    ldx $076c,y
    cpx #$3a
    bcs _ad5e
    lda $0764
    bmi _ad58
    sta $0765
    asl
    bmi _ad58
    asl
    bmi _ad58
    clc
    adc $0765
    bmi _ad58
    asl
    bmi _ad58
    adc $076c,y
    sec
    sbc #$30
_ad58:
    sta $0764
    iny
    bne _ad34
_ad5e:
    iny
    cmp #$00
    bne _ad65
    lda #$01
_ad65:
    rts

_ad66:
    jsr _adf0
    cpy #$ff
    beq _ad82
    lda $076c,y
    cmp #$30
    beq _ad82
    cmp #$31
    beq _ad96
    cmp #$32
    beq _adb6
_ad7c:
    jsr _ad24
    jmp set_cursor_pos

_ad82:
    jsr get_cursor_pos
    cpy $0798
    beq _ad90
    jsr clear_to_line_end
    jmp _ad82
_ad90:
    jsr _ad00
    jmp _ad7c
_ad96:
    lda #$1e       ; Home
    jsr OSWRCH
_ad9b:
    jsr get_cursor_pos
    cpy $0768
    bcs _ada9
    jsr clear_to_line_end
    jmp _ad9b
_ada9:
    lda #$4f
    sec
    sbc $0767
    tax
    jsr clear_to_line_end
    jmp _ad7c
_adb6:
    lda #$0c       ; Clear text window
    jsr OSWRCH
    jmp _ad7c

_adbe:
    jsr _adf0
    cpy #$ff
    beq _add7
    lda $076c,y
    cmp #$30
    beq _add7
    cmp #$31
    beq _addd
    cmp #$32
    beq _ade5
    jmp _ad7c
_add7:
    jsr _ad00
    jmp _ad7c
_addd:
    lda #$0d       ; Carriage return
    jsr OSWRCH
    jmp _ada9
_ade5:
    lda #$0d       ; Carriage return
    jsr OSWRCH
    jsr _ad00
    jmp _ad7c

_adf0:
    lda #$00
    ldy #$18
    tax
    jsr define_text_window
    jsr _abc7
    jsr record_cursor_pos
    ldy $0764
    dey
    rts

define_text_window:             ; X=left, Y=bottom, A=top
    pha
    lda #$1c       ; Define text window
    jsr OSWRCH
    txa
    jsr OSWRCH
    tya
    jsr OSWRCH
    lda #$4f       ; Full screen width
    jsr OSWRCH
    pla
    jmp OSWRCH

_ae1a:
    ldy $35ed
    ldx $37de,y
    lda $37e2,y
    pha
    lda #$1f            ; Set modem operating mode
    jsr ram_osword_81
    pla
    tax
    lda #$20            ; Set modem data word configuration
    jsr ram_osword_81
    jmp _b7b4

_ae33:
    bit $079a
    bpl _ae39
    rts
; Via table at aa52:
_ae39:
    bit $079a
    bmi _ae7b
    lda #$80
    sta $079b
    lda #$01
    sta $079c
    lda #$9b
    ldy #$07
    ldx #$40
    jsr $3300
    bne _aeb1
    lda #$08
    bit $3419
    bne _ae5c
    lda #$07
_ae5c:
    sta $079c
    lda #$9b
    ldy #$07
    ldx #$41
    jsr $3300
    bne _aeb1
    jsr _ab41
    lda $035f
    ora #$20
    sta $035f
    lda #$80
    sta $079a
    rts
_ae7b:
    lda $079a
    bpl _aea5
    lda #$00
    jsr _aebe
    lda #$80
    sta $079b
    lda #$9b
    ldy #$07
    ldx #$43
    jsr $3300
    bne _aeb1
    lda #$9b
    ldy #$07
    ldx #$44
    jsr $3300
    bne _aeb1
    jsr _ab41
    lda #$01
_aea5:
    sta $079a
    lda $035f
    and #$df
    sta $035f
    rts
_aeb1:
    lda #$9b
    ldy #$07
    ldx #$44
    jsr $3300
    lda #$00
    beq _aea5
_aebe:
    pha
    txa
    pha
    tya
    pha
    bit $079a
    bpl _aee4
    tsx
    lda $0103,x
    cmp #$0d
    beq _aee4
    inc $07a1
    ldx $07a1
    sta $07a1,x
    cmp #$0e
    bcc _aee1
    cpx #$50
    bcc _aee4
_aee1:
    jsr _aeea
_aee4:
    pla
    tay
    pla
    tax
    pla
    rts
_aeea:
    pha
    jsr record_cursor_pos
    inc $07a1
    lda #$a1
    sta $079d
    lda #$07
    sta $079e
    lda #$9b
    ldy #$07
    ldx #$42
    jsr $3300
    beq _af0c
    jsr _af94
    jsr _aeb1
_af0c:
    ldx #$00
    stx $07a1
    pla
    rts

; Via table at aa52:
_af13:
    bit $0777
    bmi _af38
    lda $0776
    bne _af20
    jsr _be21
_af20:
    ldx #$00
    stx $3366
    dex
    stx $0776
    stx $0777
    jsr _ab41
    lda $035f
    ora #$40
    sta $035f
    rts
_af38:
    lda $3366
    beq _af42
    lda #$0d
    jsr _af52
_af42:
    lda #$01
    sta $0777
    lda $035f
    and #$bf
    sta $035f
    jmp _ab41

_af52:
    pha
    cmp #$0d
    beq _af71
    cmp #$08
    bne _af60
    dec $3366
    bmi _af8d
_af60:
    cmp #$20
    bcc _af92
    inc $3366
    ldx $3366
    sta $3366,x
    cpx #$4a
    bcc _af92
_af71:
    jsr _beb4
    bcc _af85
    jsr record_cursor_pos
    jsr _be19
    jsr _af94
    jsr _af42
    jmp _af8d
_af85:
    inc $3366
    ldx #$89
    jsr $3300
_af8d:
    ldx #$00
    stx $3366
_af92:
    pla
    rts
_af94:
    ldx #$25
_af96:
    lda _afaa,x         ; Write a character from the string below
    jsr OSWRCH
    dex
    bpl _af96
_af9f:
    lda #$7a
    jsr OSBYTE
    inx
    beq _af9f
    jmp _be12
_afaa:
.byte $07," yek a sserP",$0d,$0a,$07," *** DETROBA ***"
.byte $0a,$0a,$17,$00,$1f,$07   ; VDU 7, 31,0,23, 10,10

_afd0:
    jsr get_cursor_pos
    stx $0769
    sty $076a
    bit $079a
    bmi _b02a
    jsr _ae39
    bit $079a
    bpl _b02a
    jsr _b44c
    lda #$05
    sta $0778      ; y=5
_afee:
    lda #$0a
    jsr _aebe
    dec $0778      ; y--
    bne _afee
    lda #$08
    bit $3419
    bne _b03c
    lda #$1e
    pha
    lda $0798
    sta $0778
_b008:
    pla
    jsr OSWRCH
    jsr _ba58
    txa
    jsr _aebe
    pha
    lda $07a1
    bne _b008
    lda #$0a
    jsr _aebe
    dec $0778      ; y--
    bpl _b008
    pla
_b024:
    jsr _ae7b
    jsr _be12
_b02a:
    ldx $0769
    stx $0767
    ldx $076a
    stx $0768
    jsr set_cursor_pos
    jmp _b447
_b03c:
    lda #$58
    sta $34
    lda #$00
    sta $33
    lda #$19
    sta $0778      ; y=25

_b049:
    lda #$28        ; ?<
    sta $077c
    ldx #$08
_b050:
    lda _b0a3,x
    jsr _aebe
    dex
    bpl _b050
_b059:
    ldy #$07
_b05b:
    lda ($33),y
    sta $077d,y
    dey
    bpl _b05b
    ldy #$07
_b065:
    ldx #$07
    lda #$00
    clc
_b06a:
    rol $077d,x
    ror
    dex
    bpl _b06a
    jsr _aebe
    dey
    bpl _b065
    lda #$08
    clc
    adc $33
    sta $33
    bcc _b082
    inc $34
_b082:
    dec $077c
    bne _b059
    jsr read_key
    bcs _b090
    cpx #$90
    beq _b095
_b090:
    dec $0778      ; y--
    bne _b049
_b095:
    ldx #$05
_b097:
    lda _b0ab,x
    jsr _aebe
    dex
    bpl _b097
    jmp _b024
_b0a3:
.byte $01,$40,$4b,$1b,$0a,$18,$33,$1b
_b0ab:
.byte $0d,$0d,$0a,$32,$1b   ; >?

_b0b0:       ; RAM entry point 21
    sta $1e
    sty $1f
    jsr _b1b1
    ldx #$02
    stx $2d
    ldx #$01
    jsr $3300
    ldy #$00
_b0c2:
    jsr _b194
    beq _b0cd
    sta $0c80,y
    iny
    bne _b0c2
_b0cd:
    lda #$84
    sta $0c80,y
    lda #$1f
    sta $3623
    ldx #$16
    jsr $3300
    ldy #$00
    ldx #$06
    lda #$27
    sta $0801
_b0e5:
    jsr _b194
    beq _b11a
    and #$5f
    cmp #$58
    bne _b0f4
    cpy #$03
    bcs _b11a
_b0f4:
    lda ($1e),y
    iny
    sec
    sbc #$30
    cmp #$0a
    bcs _b0e5
    sta $07fc,x
    inx
    cpx #$07
    bne _b117
    lda $37d6
    beq _b117
    adc #$02
    asl
    asl
    adc $37d6
    asl
    sta $07fc,x
    inx
_b117:
    jmp _b0e5
_b11a:
    stx $07fc
    lda #$29
    jsr _b1a1
    lda #$7d
    ldy #$b1
    ldx #$04
    stx $2d
    ldx #$1d
    jsr $3300
    lda #$70
    sta $07f5
    lda #$17
    sta $07f6
    lda #$00
    sta $07f7
    lda #$f5
    ldy #$07
    ldx $3412
    stx $2d
    stx $07fb
    ldx #$23
    jsr $3300
    pha
    ldx #$04
    stx $2d
    ldx #$1e
    jsr $3300
    ldx #$12
    stx $2d
    ldx #$04
    jsr $3300
    pla
    tay
    and #$80
    clc
    bne _b17d
    ldx #$03
    tya
    bpl _b170
    ldx #$04
_b170:
    stx $2d
    ldx #$01
    jsr $3300
    lda #$2e
    jsr _b1a1
    sec
_b17d:
    rts

_b17e:
    lda #$2d    ; ?<
    jsr _b1a1
    and #$02
    bne _b193
    lda #$80
    ldx $07fb
    stx $2d
    ldx #$27
    jmp $3300
_b193:
    rts         ; >?

_b194:
    cpy #$16
    beq _b1a0
    lda ($1e),y
    cmp #$3b
    beq _b1a0
    cmp #$7d
_b1a0:
    rts

_b1a1:
    sta $07fe
    lda #$81
    ldx #$fc
    ldy #$07
    jsr OSWORD
    lda $07ff
    rts

_b1b1:
    lda #$27            ; Seize telephone line
    jmp ram_osword_81

_b1b6:       ; RAM entry point 20
    jsr _ba7a
    lda #$08
    ora $3419
    sta $3419
    ldx #$02
    stx $3444
    jsr _b7d5
    jsr _b9ef
    jsr _b7b9
    jsr _b7dc
    jsr _bb01
    jsr _b79c
    jsr _b74c
    lda #$16        ; MODE
    jsr OSWRCH
    lda #$04        ; 4
    jsr OSWRCH
    lda #$00
    sta $3414
    jsr _b8bf
    lda #$17
    sta $0798
_b1f2:
    jsr _b85e
    bcc _b208
    jsr _bd11
    bcc _b20b
    jsr _b71f
    sta $078b
    jsr _b401
    jmp _b1f2
_b208:
    jmp _bb18
_b20b:
    jsr read_key
    bcs _b1f2
    txa
    pha
    lda $460d
    beq _b21a
    dec $460d
_b21a:
    lda $077a
    beq _b227
    dec $077a
    bne _b227
    jsr _b238
_b227:
    pla
    jsr _b241
    jsr _b774
    cmp #$88
    bcs _b260
    jsr _b2eb
    jmp _b1f2
_b238:
    ldx #$01
    stx $2d
    ldx #$04
    jmp $3300
_b241:
    pha
    jsr _bcf6
    beq _b249
    pla
    rts
_b249:
    pla
    cmp #$5f
    beq _b257
    cmp #$23
    beq _b25a
    cmp #$60
    beq _b25d
    rts
_b257:
    lda #$60
    rts
_b25a:
    lda #$5f
    rts
_b25d:
    lda #$23
    rts
_b260:
    cmp #$9a
    bcs _b1f2
    sec
    sbc #$80
    tax
    jsr _b26e
    jmp _b1f2

_b26e:
    lda [_b26e + 2],x
    pha
    lda _b282,x
    pha
    txa
_b277:
    rts

.byte >[_b2eb - 1],>[_b2eb - 1],>[_b2eb - 1],>[_b2eb - 1]
.byte >[_b277 - 1],>[_b277 - 1],>[_b277 - 1],>[_b277 - 1]
.byte >[_b2c8 - 1],>[_b2be - 1]
_b282:
.byte                           >[_b2c3 - 1],>[_afd0 - 1]
.byte >[_bd5f - 1],>[_b277 - 1],>[_b2e4 - 1],>[_b277 - 1]
.byte >[_bc2d - 1],>[_b780 - 1]
.byte <[_b2eb - 1],<[_b2eb - 1],<[_b2eb - 1],<[_b2eb - 1]
.byte <[_b277 - 1],<[_b277 - 1],<[_b277 - 1],<[_b277 - 1]
.byte <[_b2c8 - 1],<[_b2be - 1],<[_b2c3 - 1],<[_afd0 - 1]
.byte <[_bd5f - 1],<[_b277 - 1],<[_b2e4 - 1],<[_b277 - 1]
.byte <[_bc2d - 1],<[_b780 - 1]

read_key:
    lda #$81       ; Read key
    ldx #$00
    ldy #$00
    jmp OSBYTE

_b2a5:
.byte $2a,$30,$b0,$2a,$df,$2a,$39,$30,$df,$2a,$2a
.byte $2a,$aa

_b2b2:
    lda _b2a5,y
    pha
    jsr _b2eb
    iny
    pla
    bpl _b2b2
    rts

_b2be:
    ldy #$00
    jmp _b2b2

_b2c3:
    ldy #$03
    jmp _b2b2

_b2c8:
    lda $460d
    bne _b2e1
_b2cd:
    lda #$79
    ldx #$a7
    jsr OSBYTE
    txa
    bmi _b2cd
    lda #$02
    sta $460d
    ldy #$05
    jmp _b2b2
_b2e1:
    jmp _bb18
_b2e4:
    rts

; Low (LL) and high (HH) address bytes for returning to HHLL+1
_b2e5:
.byte $90,$ae,$c3
_b2e8:
.byte $b3,$b3,$b3

_b2eb:
    pha
    sta $0796
    txa
    pha
    tya
    pha
    ldx $3444
    beq _b303
    cpx #$01
    beq _b30a
    jsr _b3c4
    bcs _b331
    bcc _b30f
_b303:
    jsr _b391
    bcs _b331
    bcc _b30f
_b30a:
    jsr _b3af
    bcs _b331
_b30f:
    ldx $3444
    lda _b2e5,x     ; Load low address byte from above
    ldy _b2e8,x     ; Load high address byte
    jsr _b855
    lda #$b8
    ldy #$0b
    jsr _b830
    bmi _b32b
    cmp #$04
    beq _b331
    clc
    bcc _b331
_b32b:
    lda #$00
    sta $3443
    sec
_b331:
    pla
    tay
    pla
    tax
    pla
    rts
_b337:
    lda $0796
    beq _b355
    jmp _b7cf

_b33f:
    lda #$0b            ; Write to serial
    ldx $0796
    beq _b355
    jmp ram_osword_81

_b349:
    ldy $37db
    dey
    beq _b355
    lda $0796
    jmp _aa02
_b355:
    rts

_b356:
    lda #$07            ; Read serial handshake
    jsr ram_osword_81
    lda $340e
    and #$01
    clc
    bne _b364
    sec
_b364:
    rts

_b365:
    clc
    ldx $3443
    bne _b36c
    sec
_b36c:
    rts

_b36d:
    lda #$0a            ; Read serial status
    jsr ram_osword_81
    lda $340e
    clc
    and #$04
    beq _b37b
    sec
_b37b:
    rts

_b37c:
    lda $37dd
    beq _b38f
    lda $0796
    cmp #$0d
    bne _b38f
    lda #$0a
    sta $0796
    clc
    rts
_b38f:
    sec
    rts

_b391:
    jsr _b36d
    bcc _b3ae
    jsr _b356
    bcc _b3ae
    jsr _b365
    bcc _b3ae
    jsr _b33f
_b3a3:
    jsr _b349
    jsr _b37c
    bcc _b3ae
    jmp _b3d9
_b3ae:
    rts

_b3af:
    jsr _b8b0
    bcc _b3d5
    jsr _b3eb
    bcc _b3ae
    jsr _b365
    bcc _b3ae
    jsr _b337
    jmp _b3a3

_b3c4:
    jsr _b8b0
    bcc _b3d5
    jsr _b3eb
    bcc _b3d4
    jsr _b337
    jmp _b3d9
_b3d4:
    rts
_b3d5:
    lda #$04
    bne _b3db
_b3d9:
    lda #$04
_b3db:
    ldx #$09
    stx $2d
    ldx #$27
    jsr $3300
    lda #$00
    sta $0796
    sec
    rts
_b3eb:
    lda #$19            ; Read modem status
    jsr ram_osword_81
    lda $340e
    clc
    and #$04
    beq _b3f9
    sec
_b3f9:
    rts

_b3fa:
    ldx #$00
    lda ($31,x)
    jmp _b757

_b401:
    lda $078b
    cmp #$7f
    bne _b40a
    lda #$ff
_b40a:
    ldx $0795
    beq _b412
    jmp _b673
_b412:
    bit $07f4
    bpl _b423
    inc $07f4
    clc
    adc #$40
    sta $078b
    jmp _b45c
_b423:
    cmp #$05
    beq _b43e
    cmp #$0c
    beq _b441
    cmp #$11
    beq _b447
    cmp #$14
    beq _b44c
    cmp #$18
    bcc _b457
    cmp #$1b
    beq _b451
    jmp _b473
_b43e:
    jmp _b99c
_b441:
    jsr _b49c
    jmp _b5a2
_b447:
    ldx #$06
    jmp $3300
_b44c:
    ldx #$05
    jmp $3300
_b451:
    lda #$ff
    sta $07f4
    rts
_b457:
    cmp #$0e
    bcc _b473
    rts
_b45c:
    cmp #$a0
    bcc _b465
    lda #$20
    jmp _b485
_b465:
    cmp #$88
    bcs _b46c
    jmp _b48b
_b46c:
    sec
    sbc #$88
    tax
    jsr _b4ce
_b473:
    cmp #$21
    bcc _b485
    jsr _b547
    jsr _b585
_b47d:
    jsr get_cursor_pos
    cpx #$00
    beq _b49c
_b484:
    rts
_b485:
    jsr _b5a2
    jmp _b47d
_b48b:
    ldx #$00
    stx $4600
    stx $4601
    lda $4607
    sta $078b
    jmp _b473
_b49c:
    ldx #$00
    stx $4600
    stx $4601
    stx $4602
    stx $4603
    stx $4604
    ldx #$20
    stx $4607
    ldx $4605
    beq _b484
    jsr get_cursor_pos
    dey
    cpy $4608
    bne _b484
    ldx #$ff
    stx $0795
    ldy $4608
    iny
    iny
    sty $460c
    rts
_b4ce:
    lda _b4dd,x         ; Load high address byte (HH)
    pha
    lda _b4f5,x         ; Load low address byte (LL)
    pha
_b4d6:
    lda $4607
    sta $078b
    rts                 ; Return to $HHLL+1

_b4dd:
.byte >[_b4d6 - 1],>[_b4d6 - 1],>[_b4d6 - 1],>[_b4d6 - 1]
.byte >[_b518 - 1],>[_b51e - 1],>[_b4d6 - 1],>[_b4d6 - 1]
.byte >[_b4d6 - 1],>[_b50d - 1],>[_b50d - 1],>[_b50d - 1]
.byte >[_b50d - 1],>[_b50d - 1],>[_b50d - 1],>[_b50d - 1]
.byte >[_b52d - 1],>[_b533 - 1],>[_b537 - 1],>[_b4d6 - 1]
.byte >[_b4d6 - 1],>[_b4d6 - 1],>[_b541 - 1],>[_b53d - 1]
_b4f5:
.byte <[_b4d6 - 1],<[_b4d6 - 1],<[_b4d6 - 1],<[_b4d6 - 1]
.byte <[_b518 - 1],<[_b51e - 1],<[_b4d6 - 1],<[_b4d6 - 1]
.byte <[_b4d6 - 1],<[_b50d - 1],<[_b50d - 1],<[_b50d - 1]
.byte <[_b50d - 1],<[_b50d - 1],<[_b50d - 1],<[_b50d - 1]
.byte <[_b52d - 1],<[_b533 - 1],<[_b537 - 1],<[_b4d6 - 1]
.byte <[_b4d6 - 1],<[_b4d6 - 1],<[_b541 - 1],<[_b53d - 1]

_b50d:
    ldx #$ff
    stx $4600
    ldx #$00
    stx $4601
    rts

_b518:
    ldx #$00
    stx $4602
    rts

_b51e:
    ldx #$ff
    stx $4602
    stx $4605
    jsr get_cursor_pos
    sty $4608
    rts

_b52d:
    ldx #$ff
    stx $4601
    rts

_b533:
    ldx #$00
    beq _b539
_b537:
    ldx #$ff
_b539:
    stx $4603
    rts

_b53d:
    ldx #$00
    beq _b543
_b541:
    ldx #$ff
_b543:
    stx $4604
    rts

_b547:
    cmp #$5f
    bcs _b54f
    cmp #$5b
    bcs _b55e
_b54f:
    ldx $4600
    cpx #$00
    beq _b561
    cmp #$40
    bcc _b55e
    cmp #$5b
    bcc _b584
_b55e:
    ora #$80
    rts
_b561:
    cmp #$23
    beq _b570
    cmp #$60
    beq _b574
    cmp #$5f
    beq _b578
    jmp _b57a
_b570:
    lda #$60
    bne _b57a
_b574:
    lda #$5f
    bne _b57a
_b578:
    lda #$23
_b57a:
    cmp #$7b
    bcc _b584
    cmp #$7f
    bcs _b584
    adc #$20
_b584:
    rts

_b585:
    ldx $4601
    cpx #$ff
    bne _b58e
    lda #$20
_b58e:
    ldx $4603
    cpx #$ff
    bne _b598
    jsr _b636
_b598:
    ldx $4602
    cpx #$ff
    bne _b5a2
    jmp _b5cc
_b5a2:
    ldx #$00
    stx $460b
    jsr _b6ad
    ldx $460b
    cpx #$ff
    beq _b5b4
    jsr OSWRCH
_b5b4:
    ldx $4604
    cpx #$ff
    beq _b5c1
_b5bb:
    ldx #$20
    stx $4607
    rts
_b5c1:
    ldx $4600
    cpx #$ff
    bne _b5bb
    sta $4607
    rts
_b5cc:
    sta $078b
    cmp #$21
    bcs _b5d8
    lda #$20
    jmp _b623
_b5d8:
    jsr _b627
    lda #$17        ; VDU 23
    jsr OSWRCH
    lda #$8c        ; 140
    jsr OSWRCH
    ldx #$01
*
    lda $077c,x
    jsr OSWRCH
    jsr OSWRCH
    inx
    cpx #$05
    bcc -
    lda #$17        ; VDU 23
    jsr OSWRCH
    lda #$8d        ; 141
    jsr OSWRCH
*
    lda $077c,x
    jsr OSWRCH
    jsr OSWRCH
    inx
    cpx #$09
    bcc -
    lda #$8c        ; 140
    jsr OSWRCH
    lda #$0a        ; newline
    jsr OSWRCH
    lda #$08        ; backspace
    jsr OSWRCH
    lda #$8d        ; 141
    jsr OSWRCH
    lda #$0b        ; up
_b623:
    jsr OSWRCH
    rts

_b627:
    sta $078b
    ldx #$7c
    ldy #$07
    sta $077c
    lda #$0a        ; Read character definition into $077c
    jmp OSWORD
_b636:
    sta $078b
    cmp #$a0
    bcc _b672
    cmp #$c0
    bcs _b66e
_b641:
    jsr _b627
    ldx #$01
    ldy #$00
    lda #$17        ; VDU 23
    jsr OSWRCH
    lda #$8e        ; 142
    jsr OSWRCH
_b652:
    cpx #$03
    beq _b66a
    cpx #$06
    beq _b66a
    lda $077c,x
    and #$77
_b65f:
    jsr OSWRCH
    inx
    cpx #$09
    bcc _b652
    lda #$8e
    rts
_b66a:
    lda #$00
    beq _b65f
_b66e:
    cmp #$e0
    bcs _b641
_b672:
    rts

_b673:
    cmp #$0c       ; Clear text area?
    beq _b689
    cmp #$0d       ; Carriage return?
    beq _b689
    cmp #$1e       ; Home?
    beq _b689
    cmp #$0a       ; Newline?
    beq _b689
    cmp #$1b       ; Reserved?
    beq _b6a4
    lda #$09       ; Forward (tab)?
_b689:
    jsr OSWRCH
    jsr get_cursor_pos
    cpy #$00       ; Top row?
    beq +
    cpy $460c
    bcc _b6a4
    ldx #$00       ; Left column?
*   cpx #$00
    bne _b6a4
    stx $4605
    stx $0795
_b6a4:
    rts

get_cursor_pos:
    pha
    lda #$86       ; Read cursor position (POS and VPOS)
    jsr OSBYTE
    pla
    rts
_b6ad:
    pha
    cmp #$0c
    beq _b6c1
    cmp #$1e
    beq _b6c1
    jsr get_cursor_pos
    cpy #$00
    beq _b6eb
    cpy #$17
    beq _b6c3
_b6c1:
    pla
    rts
_b6c3:
    cmp #$0a
    beq _b6d5
    cpx #$27
    bne _b6c1
    cmp #$0d
    beq _b6c1
    cmp #$08
    beq _b6c1
    ldx #$00
_b6d5:
    jsr _b712
    pha
    lda #$1f
    jsr OSWRCH
    txa
    jsr OSWRCH
    lda #$00
    jsr OSWRCH
    pla
    jmp _b6c1
_b6eb:
    cmp #$0b
    beq _b6fc
    cpx #$00
    bne _b6c1
    ldx #$27
    cmp #$08
    beq _b6fc
    jmp _b6c1
_b6fc:
    jsr _b712
    pha
    lda #$1f       ; VDU 31 (TAB)
    jsr OSWRCH
    txa            ; X
    jsr OSWRCH
    lda #$17       ; 23
    jsr OSWRCH
    pla
    jmp _b6c1
_b712:
    cmp #$0e
    bmi _b719
    jsr OSWRCH
_b719:
    ldy #$ff
    sty $460b
    rts

_b71f:
    pha
    cmp #$0c
    beq _b73a
    cmp #$58
    beq _b740
    cmp #$09
    bne _b72e
    lda #$20
_b72e:
    ldx #$00
    sta ($31,x)
    sta $4606
    jsr _b757
    pla
    rts
_b73a:
    jsr _b74c
    jmp _b72e
_b740:
    ldx $4606
    cpx #$1b
    bne _b749
    lda #$41
_b749:
    jmp _b72e

_b74c:
    pha
    lda #$48
    sta $32
    lda #$00
    sta $31
    pla
    rts

_b757:
    pha
    inc $31
    bne _b767
    inc $32
    lda $32
    cmp #$4c
    bne _b767
    jsr _b74c
_b767:
    pla
    rts

_b769:
    pha
    lda $31
    bne _b770
    dec $32
_b770:
    dec $31
    pla
    rts

_b774:
    pha
    lda #$ff
    ldx #$00
    sta ($31,x)
    jsr _b757
    pla
    rts

_b780:
    jsr _b74c
    lda #$1e       ; VDU 30 (Home)
    jsr OSWRCH
    jsr _b757
_b78b:
    jsr _b3fa
    sta $078b
    cmp #$ff
    bne _b796
    rts
_b796:
    jsr _b401
    jmp _b78b

_b79c:
    lda #$10            ; Enable modem transmitter
    jsr ram_osword_81
    lda #$17            ; Write modem handshake
    ldx #$02
    jmp ram_osword_81

_b7a8:
    lda #$17            ; Write modem handshake
    ldx #$82
_b7ac:
    jsr ram_osword_81
    lda #$11            ; Disable modem transmitter
    jmp ram_osword_81

_b7b4:
    lda #$12            ; Enable modem receiver
    jmp ram_osword_81

_b7b9:
    lda #$1f            ; Set modem operating mode
    ldx #$02
    jsr ram_osword_81
    lda #$20            ; Set modem data word configuration
    ldx #$98
    jsr ram_osword_81
    jmp _b7b4
    lda #$27            ; Seize telephone line
    jmp ram_osword_81

_b7cf:
    tax
    lda #$1a            ; Write byte to modem transmit holding register
    jmp ram_osword_81

_b7d5:
    ldx #$ff
_b7d7:
    lda #$2a            ; Turn PSTN line monitor speaker on/off
    jmp ram_osword_81

_b7dc:
    lda #$70
    sta $07f5
    lda #$17
    sta $07f6
    lda #$00
    sta $07f7
    ldx #$09
    stx $2d
    lda #$f5
    ldy #$07
    ldx #$24
    jsr $3300
    ldy #$00
_b7fa:
    lda $07f5,y
    sta $0787,y
    iny
    cpy #$03
    bne _b7fa
    jsr _b810
_b808:
    ldx #$00
    stx $3620
    jmp _b7d7
_b810:
    lda #$9e
    ldy #$b8
    jsr _b855
_b817:
    lda #$64
    ldy #$00
    jsr _b830
    bmi _b82f
    and #$08
    bne _b829
    jsr _b885
    bpl _b817
_b829:
    jsr _b808
    jmp _bb18
_b82f:
    rts
_b830:
    sta $07f5
    sty $07f6
    lda #$00
    sta $07f7
    lda #$a7
    sta $3620
    ldx #$09
    stx $2d
    lda #$f5
    ldy #$07
    ldx #$23
    jsr $3300
    pha
    lda #$00
    sta $3620
    pla
    rts

_b855:
    ldx #$03
    stx $2d
    ldx #$1d
    jmp $3300

_b85e:
    jsr _b8b0
    bcs _b884
    lda #$97
    ldy #$b8
    jsr _b855
_b86a:
    lda #$32
    ldy #$00
    jsr _b830
    clc
    bmi _b884
    tax
    and #$08
    bne _b884
    dec $07f3
    bmi _b884
    sec
    txa
    and #$04
    beq _b86a
_b884:
    rts

_b885:
    ldy #$00
    sec
    php
_b889:
    plp
    lda $0787,y
    sbc $07f5,y
    php
    iny
    cpy #$03
    bne _b889
    plp
    rts
    jsr _b8b0
    bcc _b8af
    bcs _b8a4
    jsr _b8b0
    bcs _b8af
_b8a4:
    ldx #$09
    stx $2d
    lda #$04
    ldx #$27
    jmp $3300
_b8af:
    rts

_b8b0:
    pha
    lda #$40
    jsr OSBYTE
    txa
    and #$08
    clc
    bne _b8bd
    sec
_b8bd:
    pla
    rts

_b8bf:
    jsr _b8e5
    ldx #$a0
_b8c4:
    stx $0794
    jsr _b91d
    ldx $0794
    inx
    cpx #$c0
    bne _b8c4
    ldx #$e0
_b8d4:
    stx $0794
    jsr _b91d
    ldx $0794
    inx
    cpx #$00
    bne _b8d4
    jmp _bbc1

_b8e5:
    ldx #$03       ; &E0-&FF (OSHWM+&200 to OSHWM+&2FF)
    lda #$14       ; Explode soft character RAM allocation
    jsr OSBYTE
    lda #$ae       ; Read VDU variables origin
    ldx #$00
    ldy #$ff
    jsr OSBYTE
    stx $2f
    sty $30
    ldy #$6b
_b8fb:
    lda [_b8a4 - 3],y   ; $b8a1,y
    sta ($2f),y
    clc
    adc #$01
    iny
    cpy #$6f
    bne _b8fb
    rts

_b909:
.byte $43,$44,$45
_b90c:              ; Accessed by $b8a1,y with Y=$6b
.byte $0c,$40,$41,$42

_b910:
    ldx #$00
    lda #$00
_b914:
    sta $078c,x
    inx
    cpx #$08
    bne _b914
    rts

_b91d:
    jsr _b910
    lda $0794
    cmp #$e0
    bcs _b92a
    sec
    sbc #$a0
_b92a:
    and #$3f
    sta $460a
    ldy #$00
_b931:
    sty $4609
    ldx #$01
    jsr _b95c
    iny
    cpy #$03
    bne _b931
_b93e:
    sty $4609
    ldx #$04
    jsr _b95c
    iny
    cpy #$05
    bne _b93e
_b94b:
    sty $4609
    ldx #$10
    jsr _b95c
    iny
    cpy #$08
    bne _b94b
    jsr _b983
    rts
_b95c:
    txa
    pha
    bit $460a
    beq _b96f
    ldx $4609
    lda $078c,x
    clc
    adc #$f0
    sta $078c,x
_b96f:
    pla
    asl
    bit $460a
    beq _b982
    ldx $4609
    lda $078c,x
    clc
    adc #$0f
    sta $078c,x
_b982:
    rts
_b983:
    lda #$17        ; VDU 23
    jsr OSWRCH
    lda $0794
    jsr OSWRCH
    ldx #$00
_b990:
    lda $078c,x
    jsr OSWRCH
    inx
    cpx #$08
    bne _b990
    rts

_b99c:
    ldx $35ed
    beq _b9c2
    lda #$00
    sta $077a
    php
    sei
    jsr _b9ce
    ldx #$79
    jsr _b9d5
    ldy #$00
_b9b2:
    tya
    pha
    lda $fd53,y
    jsr _b9c3
    pla
    tay
    iny
    cpy #$0a
    bcc _b9b2
    plp
_b9c2:
    rts

_b9c3:
    inc $077a
    tay
    lda #$99            ; Insert character into keyboard buffer (X=0)
    ldx #$00
    jmp OSBYTE
_b9ce:
    lda #$15            ; Flush keyboard buffer (X=0)
    ldx #$00
    jmp OSBYTE
_b9d5:
    inc $077a
    stx $2d
    ldx #$01
    jsr $3300
    jsr _bcf6
    beq _b9ec
    jsr _b447
    ldx #$ff
    stx $0799
_b9ec:
    jmp set_cursor_pos
_b9ef:
    ldx $35ed
    ldy _ba06,x
    lda _ba09,x
_b9f8:
    ldx #$a7
    stx $3620
    jsr _b0b0
    bcc _ba05
    jmp _bb18
_ba05:
    rts

_ba06: .byte $35,$fd,$fd
_ba09: .byte $ee,$64,$7a

_ba0c:
    lda #$91
    ldy #$fd
    ldx $35ed
_ba13:
    dex
    beq _ba1e
    clc
    adc #$16
    bcc _ba13
    iny
    bne _ba13
_ba1e:
    jmp _b9f8

_ba21:
.byte $60

_ba22:
    lda #$1f       ; VDU 31 (TAB)
    jsr OSWRCH
    lda $078a      ; x
    jsr OSWRCH
    lda $0778      ; y
    jsr OSWRCH
    ldx $078a      ; x
    inx
    txa
    pha
_ba39:
    jsr _ba58
    pla
    tay
    txa
    sta $3366,y
    dey
    beq _ba4f
    tya
    pha
    lda #$08        ; backspace
    jsr OSWRCH
    jmp _ba39
_ba4f:
    ldx $078a      ; x
    inx
    inx
    stx $3366
    rts

_ba58:
    jsr get_char_at_cursor
    bne _ba69
    jsr _abe5
    jsr get_char_at_cursor
    pha
    jsr _abe5
    pla
    tax
_ba69:
    bmi _ba70
    cpx #$20
    bcc _ba70
    rts
_ba70:
    ldx #$20
    rts

get_char_at_cursor:
    lda #$87       ; Read character at cursor position
    jsr OSBYTE     ; X=character value or 0, Y=graphics mode
    txa            ; Transfer character to A
    rts

_ba7a:
    lda $0204
    sta $3440
    lda $0205
    sta $3441
    lda $37dc
    sta $3446
    lda #$80
    bit $3418
    beq _bb0b
    lda #$e5        ; Write 1 to ESCAPE status
    ldx #$01
    ldy #$00
    jsr OSBYTE
    lda #$80
    sta $0779
_baa1:
    ldx #$00
    stx $3447
    stx $3448
    lda #$c0
    sta $3442
    stx $0776
    stx $0777
    stx $077b
    stx $3443
    stx $3445
    stx $0796
    stx $077a
    stx $079a
    stx $07a1
    stx $07f4
    ldx #$49
    stx $078a      ; x=73
    ldx #$02
    stx $07f3
    lda #$85
    sta $0794
    ldx #$00
_badd:
    lda _baeb,x
    sta $078c,x
    inx
    cpx #$08
    bcc _badd
    jmp _b983

_baeb:
.byte $ff,$9f,$b1,$95,$b1,$95,$f5,$ff

_baf3:
    ldx #$30
    jsr $3300
    lda #$03
    sta $2d
    ldx #$1b
    jmp $3300

_bb01:
    jsr _baf3
    ldx #$02
    lda #$1b            ; Enable modem interrupts
    jmp ram_osword_81

_bb0b:
    lda #$02
    sta $35ec
    lda #$ff
    sta $3622
    jmp _bb9d

; Via the table at aa52:
_bb18:
    lda $3444
    beq _bb3d
    ldx #$c0
    jsr $3300
    ldx #$9a
    jsr $3300
    jsr _b7a8
    ldx #$02
    lda #$1c            ; Disable modem interrupts
    jsr ram_osword_81
    ldx #$03
    stx $2d
    ldx #$1c
    jsr $3300
    jmp _bb40
_bb3d:
    jsr _ab30
_bb40:
    ldx #$00
    stx $3444
    stx $3620
    jsr _b7d7
    ldx #$03
    stx $2d
    ldx #$1e
    jsr $3300
    lda #$f5
    ldy #$07
    ldx #$25
    jsr $3300
    lda $079a
    bvs _bb69
    bmi _bb69
    beq _bb77
    jsr _ae39
_bb69:
    ldx #$06
_bb6b:
    lda _bbba,x
    jsr _aebe
    dex
    bpl _bb6b
    jsr _ae7b
_bb77:
    bit $0777
    bpl _bb7f
    jsr _af38
_bb7f:
    lda #$ff
    sta $3414
    lda $0779
    pha
    ldx #$00
    jsr $3300
    pla
    tax
    lda $3419
    and #$04
    beq _bb9a
    cpx #$81
    bne _bb9d
_bb9a:
    jsr $3300
_bb9d:
    lda #$e5        ; Write 0 to ESCAPE status
    ldx #$00
    ldy #$00
    jsr OSBYTE
    lda $3440
    ldy $3441
    php
    sei
    sta $0204
    sty $0205
    plp
    ldx $3413
    txs
    rts

_bbba:
.byte $40,$1b,$0a,$0a,$0a,$0a,$0d

_bbc1:
    ldx #$00
_bbc3:
    lda _bbd2,x
    cmp #$ff
    beq _bbd1
    jsr OSWRCH
    inx
    jmp _bbc3
_bbd1:
    rts

_bbd2:
.byte $17,$db,$10,$30,$60,$fe,$60,$30,$10,$00   ; VDU 23,219,...
.byte $17,$dc,$20,$20,$2c,$22,$24,$08,$0f,$00
.byte $17,$dd,$08,$0c,$06,$7f,$06,$0c,$08,$00
.byte $17,$de,$18,$3c,$7e,$5b,$18,$18,$18,$00
.byte $17,$df,$14,$14,$7f,$14,$7f,$14,$14,$00
.byte $17,$9b,$40,$40,$41,$43,$05,$07,$01,$00
.byte $17,$9c,$28,$28,$28,$28,$28,$28,$28,$00
.byte $17,$9d,$70,$08,$71,$0b,$75,$07,$01,$00
.byte $17,$9e,$00,$10,$00,$7e,$00,$00,$10,$00
.byte $ff
; The $ff byte terminates the block of data

; Via table at aa52:
_bc2d:
    lda $0776
    cmp #$ff
    beq _bc71
    lda $077b
    bne _bc41
    lda #$ff
    sta $077b
    jsr _bcfc
_bc41:
    jsr record_cursor_pos
    lda $3573
    beq _bc79
    ldx #$8c
    jsr $3300
    lda $3366
    cmp #$02
    bne _bc5c
    lda $3367
    cmp #$23
    beq _bc69
_bc5c:
    jsr _bc90
    bcc _bc69
    ldx #$8d
    jsr $3300
    jmp _bc41
_bc69:
    ldx #$8d
    jsr $3300
    jmp _bc79

_bc71:
    ldx #$7b
    jsr _b9d5
    jmp _be12

_bc79:
    jsr _bcf6
    bne _bc83
    lda #$5f
    jsr _b2eb
_bc83:
    lda $3573
    bne _bc8b
    jsr _bcfc
_bc8b:
    lda #$07            ; Bell
    jmp OSWRCH

_bc90:
    ldx $3366
    dex
    beq _bcb9
    inx
    stx $0785
    ldx #$01
_bc9c:
    lda $3366,x
    jsr _b241
    jsr _b2eb
    bcc _bcd8
    txa
    pha
    ldx #$00
    stx $0797
    jsr _bcd9
    pla
    tax
    inx
    cpx $0785
    bcc _bc9c
_bcb9:
    jsr _bcf6
    beq _bcc3
    lda #$0d
    jmp _b2eb
_bcc3:
    cpx #$29
    bcs _bcd8
    lda #$20
    jsr _b2eb
    bcc _bcd8
    txa
    pha
    jsr _bcd9
    pla
    tax
    inx
    bne _bcc3
_bcd8:
    rts
_bcd9:
    jsr _bd11
    bcc _bcf5
    sta $078b
    jsr _bcf6
    beq _bcef
    lda $078b
    jsr _aa82
    jmp _bcd9
_bcef:
    jsr _b401
    jmp _bcd9
_bcf5:
    rts
_bcf6:
    lda $3419
    and #$10
    rts

_bcfc:
    ldx #$88
    lda #$01
    sta $3573
    lda #$02
    sta $3574
    jsr $3300
    lda #$81
    sta $0779
    rts

_bd11:
    lda $3442
    cmp #$b0
    bcc _bd1b
    jsr _bd37
_bd1b:
    ldx $3448
    cpx $3447
    beq _bd35
    lda $3449,x
    inc $3442
    inx
    cpx #$c0
    bne _bd30
    ldx #$00
_bd30:
    sec
    stx $3448
    rts
_bd35:
    clc
    rts
_bd37:
    lda $3444
    bne _bd43
    lda #$08                ; Write RS423 handshake
    ldx #$01
    jsr ram_osword_81
_bd43:
    jsr _bcf6
    beq _bd57
    lda $3445
    beq _bd57
    lda #$11
    jsr _b2eb
    lda #$00
    sta $3445
_bd57:
    rts

_bd58:
    lda #$0f                ; Set RS423 handshake level
    ldx #$00
    jmp ram_osword_81

; Via table at aa52:
_bd5f:
    jsr _b74c
    jsr record_cursor_pos
    ldx #$ff
    stx $0778      ; y=255
    bit $0777
    bpl _bd74
    lda #$0d
    jsr _af52
_bd74:
    lda $0776
    bne _bd81
    lda #$ff
    sta $0776
    jsr _be21
_bd81:
    inc $0778      ; y++
    ldx $0778
    cpx #$19
    bcs _be03
    jsr _bcf6
    bne _bdac
    dec $0778      ; y--
    jsr _be40
    cmp #$ff
    bne _bd9f
    lda #$19
    sta $0778      ; y=25
_bd9f:
    jsr _beb4
    bcs _be19
_bda4:
    ldx #$89
    jsr $3300
    jmp _bd81
_bdac:
    jsr _ba22
    jsr _beb4
    bcs _be19
    ldx #$89
    jsr $3300
    jsr _bdc6
    bcs _bd81
    jsr _beb4
    bcs _be19
    jmp _bda4
_bdc6:
    lda #$1f       ; VDU 31 (TAB)
    jsr OSWRCH
    lda #$4f       ; x=79 (rightmost column)
    jsr OSWRCH
    lda $0778      ; y
    jsr OSWRCH
    lda #$00
    sta $078b
    ldy #$07
    sty $3366
_bde0:
    dey
    beq _bdfd
    tya
    pha
    jsr _ba58
    pla
    tay
    txa
    sta $3366,y
    cmp #$21
    bcc _bdf5
    dec $078b
_bdf5:
    lda #$08       ; Backspace
    jsr OSWRCH
    jmp _bde0
_bdfd:
    lda #$00
    cmp $078b
    rts

_be03:
    lda #$00
    sta $3366
    lda #$07       ; Bell
    jsr OSWRCH
    ldx #$78
    jsr _b9d5
_be12:
    lda #$15       ; Flush buffer
    ldx #$00       ; Keyboard
    jmp OSBYTE

_be19:
    ldx #$7a
    jsr _b9d5
    jmp _be12

_be21:
    lda #$81
    sta $0779
    lda #$71
    ldy #$35
    ldx #$4c
    jsr $3300
    ldx #$bd
    jsr $3300
    jsr _bcfc
    lda $3419
    and #$fb
    sta $3419
    rts

_be40:
    ldx #$00
    stx $4600
    inx
    stx $0786
_be49:
    ldx $0786
    cpx #$29
    bcs _be83
    jsr _b3fa
    cmp #$0d
    beq _be72
    cmp #$0a
    beq _be72
    cmp #$ff
    beq _be83
    jsr _be8a
    cmp #$20
    bcc _be49
    ldx $0786
    sta $3366,x
    inc $0786
_be6f:
    jmp _be49
_be72:
    sta $078b
    jsr _b3fa
    clc
    adc $078b
    cmp #$17
    beq _be83
    jsr _b769
_be83:
    ldx $0786
    stx $3366
    rts
_be8a:
    jsr _b561
    cmp #$1b
    beq _be9d
    cmp #$7f
    bcs _beb1
    ldx $4600
    cpx #$ff
    beq _beb1
    rts
_be9d:
    jsr _b3fa
    cmp #$51
    bcc _beac
    ldx #$ff
    stx $4600
    jmp _beb1
_beac:
    ldx #$00
    stx $4600
_beb1:
    lda #$20
    rts

_beb4:
    clc
    lda $3579
    ora $357a
    bne _bec2
    lda #$4d
    cmp $3578
_bec2:
    rts

_bec3:
.byte $d0,$05,$a9,$4d,$cd,$78,$35,$60,$05,$a9,$4d,$cd,$78
.byte $35,$60,$60,$78,$35,$60,$46,$a9,$20,$60,$18,$ad,$79,$35,$0d,$7a
.byte $35,$d0,$05,$a9,$4d,$cd,$78,$35,$60,$d0,$05,$a9,$4d,$cd,$78,$35
.byte $60,$60,$60,$20,$6f,$be,$a5,$12,$85,$45,$a5,$13,$85,$46,$a9,$23

_bf00: ; Bytes at bf01 and bf80 provide an entry point for the ROM from RAM.
.byte $03
.byte     $80,$9b,$80,$80,$97,$97,$97,$80,$82,$97,$9c,$9d,$a2,$a6,$a4
.byte $a4,$a6,$a7,$a7,$a9,$b1,$b0,$00,$00,$00,$00,$00,$00,$00,$00,$00
.byte $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
.byte $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
.byte $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
.byte $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
.byte $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
.byte $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
_bf80:
.byte $01,$5f,$bd,$e0,$70,$f8,$0e,$7c,$21,$31,$14,$7a,$4a,$37,$2b,$47
.byte $e4,$64,$da,$2f,$b5,$af,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
.byte $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
.byte $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
.byte $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
.byte $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
.byte $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
.byte $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$48
